# 🎉 警報分配系統已完成升級

## ✅ 已完成的功能

### 1. 數據庫層 Schema 更新
- ✅ 添加 `AssignmentStatus` enum（PENDING, ACCEPTED, DECLINED, CANCELLED）
- ✅ 將 `AlertAssignment.isAccepted` 改為 `status`
- ✅ 添加 `respondedAt` 記錄回應時間
- ✅ 創建並應用數據庫遷移

### 2. 前端組件
- ✅ 創建 `AssignAlertModal` 組件（成員多選界面）
- ✅ 更新 `AlertDetailScreen` 添加分配和婉拒功能
- ✅ 更新 API client 添加 `declineAlert` 方法

### 3. 後端 API
- ✅ 添加 `POST /app/alerts/:id/decline` 婉拒 API
- ✅ 改進 `acceptAlert` 邏輯，接受後自動撤銷其他人的分配
- ✅ 權限檢查完善

---

## 🎯 新的工作流程

### 管理員分配警報

```
1. 打開警報詳情頁
   ↓
2. 看到「分配狀態」卡片
   - 顯示當前已分配的成員
   - 顯示每個成員的回應狀態
   ↓
3. 點擊「分配警報」或「重新分配」按鈕
   ↓
4. 彈出成員選擇 Modal
   - 搜尋成員
   - 多選成員（可選多人）
   - 顯示管理員標記
   ↓
5. 確認分配
   ↓
6. 選中的成員都收到通知（狀態：PENDING 等待回覆）
```

### 成員回應警報

```
1. 收到警報通知
   ↓
2. 打開警報詳情
   ↓
3. 看到兩個按鈕：
   - 「接受警報」（綠色）
   - 「婉拒」（紅色外框）
   ↓
4a. 選擇「接受」
   - 自己的狀態 → ACCEPTED
   - 其他待回覆的人 → CANCELLED（自動撤銷）
   - 警報狀態 → NOTIFIED（處理中）
   - 開始處理流程
   ↓
4b. 選擇「婉拒」
   - 自己的狀態 → DECLINED
   - 警報繼續顯示給其他被分配的人
   - 退出警報詳情頁
```

---

## 📊 分配狀態說明

### PENDING（等待回覆）🟡
- 剛被分配，尚未回應
- 顯示黃色標記
- 可以接受或婉拒

### ACCEPTED（已接受）🟢
- 成員接受了此警報
- 顯示綠色標記
- 可以繼續處理和更新狀態

### DECLINED（已婉拒）🔴
- 成員婉拒了此警報
- 顯示紅色標記
- 該成員不再看到此警報

### CANCELLED（已撤銷）⚫
- 因為其他人接受而被撤銷
- 顯示灰色標記
- 該成員不再看到此警報

---

## 🎨 UI 展示

### 管理員看到的分配狀態卡片

```
┌─────────────────────────────────┐
│ 分配狀態                         │
├─────────────────────────────────┤
│ 👤 王小明                        │
│    wang@example.com              │
│                      [等待回覆]  │
│                                  │
│ 👤 李大華                        │
│    li@example.com                │
│                      [已接受]    │
│                                  │
│ 👤 陳阿姨                        │
│    chen@example.com              │
│                      [已撤銷]    │
│                                  │
│ [重新分配]                       │
└─────────────────────────────────┘
```

### 一般成員看到的操作按鈕

```
等待回覆時：
┌─────────────────────────────────┐
│ [接受警報]     [婉拒]            │
└─────────────────────────────────┘

已接受後：
┌─────────────────────────────────┐
│ [更新為處理中]                   │
│ [標記為已完成]                   │
└─────────────────────────────────┘
```

---

## 🔍 技術細節

### 數據庫 Schema 變更

**AlertAssignment 模型**：
```prisma
model AlertAssignment {
  id        String   @id @default(cuid())
  alertId   String
  appUserId String
  status    AssignmentStatus @default(PENDING)  // 新增
  respondedAt DateTime?                         // 新增
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  @@index([status])  // 新增索引
}

enum AssignmentStatus {
  PENDING    // 等待回覆
  ACCEPTED   // 已接受
  DECLINED   // 已婉拒
  CANCELLED  // 已撤銷
}
```

### 後端 API 端點

**婉拒警報**：
```
POST /app/alerts/:id/decline
Authorization: Bearer <token>

Response:
{
  "data": {
    "success": true,
    "message": "已婉拒警報",
    "remainingAssignments": 2
  }
}
```

**接受警報（改進版）**：
```
POST /app/alerts/:id/accept
Authorization: Bearer <token>

邏輯：
1. 驗證用戶被分配
2. 更新此用戶狀態為 ACCEPTED
3. 自動撤銷其他 PENDING 狀態的分配
4. 更新警報狀態為 NOTIFIED
```

---

## 🚀 使用範例

### 場景 1：緊急警報需要多人協助

```
管理員：
1. 看到高優先級警報
2. 打開詳情
3. 點擊「分配警報」
4. 選擇 3 位離長輩最近的成員
5. 確認分配

成員 A：
- 收到通知
- 打開看到「接受」和「婉拒」
- 正好在附近，點擊「接受」
- 其他 2 人的分配自動撤銷

成員 B & C：
- 收到撤銷通知
- 打開看到「此警報已由其他成員處理」
```

### 場景 2：成員忙碌無法處理

```
成員：
1. 收到警報通知
2. 打開詳情
3. 發現自己不在社區無法處理
4. 點擊「婉拒」
5. 警報繼續顯示給其他被分配的人

管理員：
- 看到該成員狀態變為「已婉拒」
- 可以重新分配給其他人
```

---

## 📋 完整的狀態流轉

```
警報觸發
  ↓
[PENDING - 待處理]
  ↓
管理員分配給 A、B、C
  ↓
A: [PENDING 等待回覆]
B: [PENDING 等待回覆]
C: [PENDING 等待回覆]
  ↓
B 婉拒
  ↓
A: [PENDING 等待回覆]
B: [DECLINED 已婉拒] ✗
C: [PENDING 等待回覆]
  ↓
A 接受
  ↓
A: [ACCEPTED 已接受] ✓
B: [DECLINED 已婉拒] ✗
C: [CANCELLED 已撤銷] ✗
  ↓
警報狀態變為 [NOTIFIED 處理中]
  ↓
A 更新狀態
  ↓
[RESOLVED 已完成] ✓
```

---

## ✅ 已更新的文件

### 數據庫
```
✅ packages/database/prisma/schema.prisma
✅ packages/database/prisma/migrations/20260116103242_add_assignment_status/
```

### 前端
```
✅ apps/mobile/src/components/AssignAlertModal.tsx (新建)
✅ apps/mobile/src/screens/alerts/AlertDetailScreen.tsx
✅ apps/mobile/src/api/alerts.ts
```

### 後端
```
✅ apps/backend/src/app-alerts/app-alerts.controller.ts
✅ apps/backend/src/app-alerts/app-alerts.service.ts
```

---

## 🧪 測試指南

### 測試 1：管理員分配警報

1. 以管理員身份登入
2. 進入警報列表 → 警報詳情
3. 看到「分配狀態」卡片
4. 點擊「分配警報」
5. 選擇 2-3 位成員
6. 確認分配
7. ✅ 檢查：成員列表顯示「等待回覆」

### 測試 2：成員接受警報

1. 以被分配的成員身份登入
2. 進入「我的警報」
3. 打開被分配的警報
4. 看到「接受警報」和「婉拒」按鈕
5. 點擊「接受警報」
6. ✅ 檢查：
   - 警報狀態變為「處理中」
   - 自己可以繼續更新狀態
   - 其他被分配的人收到撤銷

### 測試 3：成員婉拒警報

1. 以被分配的成員身份登入
2. 打開警報詳情
3. 點擊「婉拒」
4. 確認婉拒
5. ✅ 檢查：
   - 返回警報列表
   - 該警報不再顯示
   - 管理員看到「已婉拒」狀態

### 測試 4：管理員查看分配狀態

1. 以管理員身份登入
2. 打開已分配的警報
3. ✅ 檢查「分配狀態」卡片顯示：
   - 成員姓名和郵箱
   - 每個人的回應狀態
   - 顏色標記正確

---

## 💡 優化建議（未來可考慮）

### 1. 推送通知
- 分配時推送通知給被分配的成員
- 接受後推送通知給管理員
- 婉拒後推送通知給管理員

### 2. 自動重新分配
- 如果所有人都婉拒，自動通知管理員
- 智能推薦：根據成員位置、歷史表現推薦

### 3. 時間限制
- 設定回應時限（例如 15 分鐘）
- 超時未回應自動分配給其他人

### 4. 統計數據
- 每個成員的接受率
- 平均回應時間
- 完成率統計

---

## 🎊 功能完成總結

現在的警報系統：

✅ **管理員可以**：
- 分配警報給多位成員
- 查看每個成員的回應狀態
- 重新分配警報
- 查看所有警報或只看自己的

✅ **成員可以**：
- 收到分配通知
- 選擇接受或婉拒
- 接受後其他人自動撤銷
- 婉拒後警報繼續給其他人

✅ **系統自動**：
- 追蹤所有分配狀態
- 接受時撤銷其他分配
- 防止重複處理
- 完整的狀態流轉記錄

---

## 🚀 立即測試

### 重啟服務

```bash
# 1. 重啟後端（應用新的 API）
cd apps/backend
pnpm dev

# 2. 重新載入 Mobile App
# 在 Expo 終端按 'r'
```

### 測試流程

1. 以管理員登入
2. 進入警報詳情
3. 測試分配功能
4. 以其他成員登入測試接受/婉拒

---

## 📚 API 參考

### 分配警報
```typescript
POST /app/alerts/:id/assign
Body: {
  appUserIds: string[]  // 可多選
}
```

### 婉拒警報
```typescript
POST /app/alerts/:id/decline
```

### 接受警報（已改進）
```typescript
POST /app/alerts/:id/accept
// 自動撤銷其他 PENDING 的分配
```

---

## 🎨 視覺效果

### 分配 Modal
```
┌───────────────────────────────┐
│ 分配警報給成員                 │
│ 可多選，選中的成員將收到警報通知│
├───────────────────────────────┤
│ [搜尋成員]                     │
├───────────────────────────────┤
│ ☑ 👤 王小明 [管理員]          │
│      wang@example.com          │
├───────────────────────────────┤
│ ☐ 👤 李大華                   │
│      li@example.com            │
├───────────────────────────────┤
│ ☑ 👤 陳阿姨                   │
│      chen@example.com          │
├───────────────────────────────┤
│ 已選擇 2 人                    │
│ [取消]         [確認分配]      │
└───────────────────────────────┘
```

### 分配狀態顯示
```
┌───────────────────────────────┐
│ 分配狀態                       │
├───────────────────────────────┤
│ 👤 王小明                      │
│    wang@example.com            │
│                   [等待回覆]🟡 │
│                                │
│ 👤 李大華                      │
│    li@example.com              │
│                   [已接受]🟢   │
│                                │
│ 👤 陳阿姨                      │
│    chen@example.com            │
│                   [已撤銷]⚫   │
│                                │
│ [重新分配]                     │
└───────────────────────────────┘
```

---

## 🎯 改進對比

### 改進前 ❌
- ❌ 只能分配給自己
- ❌ 無法多人分配
- ❌ 無法婉拒
- ❌ 可能重複處理
- ❌ 無法追蹤回應狀態

### 改進後 ✅
- ✅ 可分配給任何社區成員
- ✅ 支持多人同時分配
- ✅ 成員可以婉拒
- ✅ 接受後自動撤銷其他人
- ✅ 完整的狀態追蹤
- ✅ 管理員可查看所有回應

---

## 💡 使用建議

### 最佳實踐

1. **分配策略**
   - 緊急警報：分配給 2-3 人確保有人處理
   - 一般警報：分配給最近的成員
   - 夜間警報：分配給值班人員

2. **回應建議**
   - 收到通知後盡快回應（接受或婉拒）
   - 如果無法處理務必婉拒，讓其他人接手
   - 接受後認真處理並更新狀態

3. **管理建議**
   - 定期檢查婉拒率高的成員
   - 分配時考慮成員的位置和空閒度
   - 追蹤處理效率，優化分配策略

---

## 🎉 完成！

警報分配系統已全面升級，現在是一個完整的**協作式警報處理系統**！

**請重啟後端並重新載入 App 開始測試！** 🚀

有任何問題隨時告訴我！
