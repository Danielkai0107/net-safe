# Safe-Net 架構審查與修正

**審查時間**: 2026-01-16  
**目的**: 釐清用戶系統並修正邏輯問題

---

## 📊 當前架構盤點

### 資料庫表格

| 表名 | 用途 | 前端管理位置 | 狀態 |
|------|------|-------------|------|
| **users** | 後台管理員 | 後台 → 人員管理 | ✅ 正確 |
| **app_users** | App 用戶 | 後台 → 社區管理 → 👥 | ⚠️ 部分正確 |
| **tenant_members** | App 用戶↔社區關係 | 後台 → 社區管理 → 👥 | ✅ 正確 |
| **tenants** | 社區 | 後台 → 社區管理 | ✅ 正確 |
| **elders** | 長者 | 後台 → 長者管理 | ✅ 正確 |
| **devices** | 設備 | 後台 → 設備管理 | ✅ 正確 |
| **alerts** | 警報 | 後台 → 警報管理 | ✅ 正確 |

---

## 🔍 發現的問題

### 問題 1: 後台缺少「App 用戶總覽」❌

**現況**:
- ✅ 可以在「社區管理 → 👥」查看已申請某社區的 App 用戶
- ❌ 無法查看所有 App 用戶（不論是否加入社區）

**影響**:
- 無法統一管理所有 App 用戶
- 無法查看未加入任何社區的用戶
- 無法全局停用/刪除 App 用戶

**解決方案**: 需要新增「App 用戶管理」頁面

---

### 問題 2: App 未加入社區時的 401 錯誤 ❌

**現象**: 
```
用戶剛註冊 → 還沒加入社區 → 查詢長輩/警報 → 返回 401
```

**預期行為**:
```
用戶剛註冊 → 還沒加入社區 → 查詢長輩/警報 → 返回空陣列 []
```

**後端代碼**（已正確）:
```typescript
// app-elders.service.ts
if (tenantIds.length === 0) {
  return { data: [], meta: {...} };  ✅ 正確返回空陣列
}
```

**問題所在**: Token 沒有正確保存或添加到請求頭

---

### 問題 3: 社區管理的 App 成員來源 ✅

**檢查結果**: ✅ **已正確實作**

```typescript
// tenants.service.ts getAppMembers()
const members = await this.databaseService.tenantMember.findMany({
  where: { tenantId },
  include: {
    appUser: { ... }  ✅ 正確使用 appUser（不是 user）
  }
});
```

這是正確的！顯示的是 `app_users` 表的資料。

---

## 🎯 正確的資料流程

### App 用戶註冊與使用流程

```
1. 註冊 (✅ 已實作)
   Mobile App → 註冊表單
   ↓
   POST /api/app/auth/register
   ↓
   創建 app_users 記錄
   ↓
   返回 Token
   
2. 登入 App (✅ 已實作)
   進入主頁面
   ↓
   查詢長輩清單
   ↓
   後端檢查 tenant_members → tenantIds = []
   ↓
   返回 { data: [] } （空陣列，不是 401）
   
3. 加入社區 (✅ 已實作)
   個人 → 加入社區 → 選擇社區
   ↓
   POST /api/app/tenants/:id/join
   ↓
   創建 tenant_members（status = PENDING）
   
4. 批准（前台或後台）(✅ 已實作)
   後台：社區管理 → 👥 → 批准
   或
   App：等待確認清單 → 批准
   ↓
   tenant_members.status = APPROVED
   
5. 查看資料 (⚠️ 有 401 問題)
   查詢長輩清單
   ↓
   後端檢查 tenant_members → tenantIds = [社區ID]
   ↓
   返回該社區的長輩資料
```

---

## 🔧 需要修正的地方

### 修正 1: Token 保存和使用問題

**症狀**: 註冊成功但後續請求返回 401

**可能原因**:
1. Token 沒有正確保存到 AsyncStorage
2. Token 沒有正確添加到請求頭
3. Token 格式不正確

**已添加的調試日誌**（已在代碼中）:
- `[Storage] Saving token`
- `[Storage] Token saved successfully`
- `[ApiClient] Request interceptor: hasToken`

---

### 修正 2: 新增「App 用戶管理」頁面（建議）

**位置**: 後台 → App 用戶管理（新頁面）

**功能**:
- 列出所有 App 用戶（app_users 表）
- 查看用戶詳情
- 查看用戶已加入的社區
- 啟用/停用用戶
- 刪除用戶
- 重置密碼

**API**: 需要新增
```
GET /api/app-users          - 列表
GET /api/app-users/:id      - 詳情
PATCH /api/app-users/:id    - 更新
DELETE /api/app-users/:id   - 刪除
```

---

## 📋 後台前端功能對照

### 當前後台頁面

| 頁面 | 管理的表 | 查看資料 | 完整度 |
|------|---------|---------|--------|
| 儀表板 | 統計 | 系統總覽 | 100% ✅ |
| 社區管理 | tenants | 社區資料 | 100% ✅ |
| 社區管理 → 👥 | tenant_members + app_users | 該社區的 App 成員 | 100% ✅ |
| 社區管理 → 📱 | devices | 該社區的設備 | 100% ✅ |
| 人員管理 | users | 後台管理員 | 100% ✅ |
| **App 用戶管理** | **app_users** | **所有 App 用戶** | ❌ **缺少** |
| 長者管理 | elders | 長者資料 | 100% ✅ |
| 設備管理 | devices | 設備資料 | 100% ✅ |
| 接收點管理 | gateways | 接收點資料 | 100% ✅ |
| 警報管理 | alerts | 警報資料 | 100% ✅ |

---

## 🎯 建議的改進

### 立即修正（必須）

1. **修正 Token 保存問題** - 讓註冊後能正常查詢資料
2. **確認 401 錯誤原因** - 使用調試日誌追蹤

### 功能補充（建議）

3. **新增「App 用戶管理」頁面** - 統一管理所有 App 用戶
4. **App 未加入社區時顯示提示** - 引導用戶加入社區

---

## 🎨 UI 架構建議

### 後台側邊欄（建議增加）

```
📊 總覽
🏢 社區管理
  ├─ 社區列表
  ├─ 👥 App 成員（點擊社區）
  └─ 📱 設備管理（點擊社區）
👥 人員管理（後台管理員）
📱 App 用戶管理（建議新增）← 管理所有 App 用戶
👴 長者管理
📱 設備管理
📡 接收點管理
🔔 警報管理
```

---

## 🔄 下一步行動

### 步驟 1: 先修正 Token 問題（當前）

使用調試日誌確認：
- Token 是否正確保存
- Token 是否正確添加到請求頭
- 為什麼會有 401

### 步驟 2: 新增 App 用戶管理（可選）

創建新的管理頁面，讓後台可以：
- 查看所有 App 用戶
- 管理用戶狀態
- 查看用戶加入的社區

---

**需要我繼續追蹤 401 錯誤嗎？還是先新增「App 用戶管理」功能？**
