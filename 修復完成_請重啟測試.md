# ✅ App Token 驗證問題已修復

**修復完成時間**: 2026-01-16 15:01  
**狀態**: 需要重啟後端服務使修復生效

---

## 🎯 已完成的修復

### 問題診斷 ✓

找到核心問題：

- 全局的 `JwtAuthGuard` 會攔截**所有路由**，包括 App 的 `/api/app/*`
- App token 用 `JWT_APP_SECRET` 簽名
- 但全局 Guard 嘗試用 `JWT_SECRET` 驗證 → 失敗返回 401

### 代碼修復 ✓

修改了 2 個文件：

1. **`apps/backend/src/auth/guards/jwt-auth.guard.ts`**

   - 讓全局 Guard 跳過 `/api/app/*` 路由
   - 添加調試日誌

2. **`apps/backend/src/auth/guards/roles.guard.ts`**
   - 讓 RolesGuard 也跳過 App 路由

### 文檔創建 ✓

- ✅ `APP_TOKEN_FIX.md` - 問題完整分析和修復說明
- ✅ `RESTART_AND_TEST.md` - 重啟和測試指南
- ✅ `test-app-api.sh` - 自動化測試腳本
- ✅ `修復完成_請重啟測試.md` - 本文件

---

## 🚀 接下來要做的事

### 第 1 步：重啟後端服務（必須！）⭐

**方式 1：手動重啟**

在終端 24（正在運行 `pnpm dev` 的終端）：

1. 按 `Ctrl+C` 停止服務
2. 重新執行：
   ```bash
   pnpm dev
   ```

**方式 2：命令重啟**

在新終端執行：

```bash
cd /Users/danielkai/Desktop/safe-net
pkill -f "pnpm dev"
sleep 2
pnpm dev
```

### 第 2 步：執行自動化測試 ✨

重啟後，在**新終端**執行：

```bash
cd /Users/danielkai/Desktop/safe-net
./test-app-api.sh
```

**預期結果**：

```
✓ 所有測試通過！

App API 修復成功！現在可以：
1. ✓ 正常註冊/登入
2. ✓ 查看長輩清單（未加入社區時返回空陣列）
3. ✓ 查看警報清單（未加入社區時返回空陣列）
4. ✓ 查看社區清單
5. ✓ 查看個人資料
6. ✓ 查看已加入的社區
```

### 第 3 步：測試 Mobile App

1. **清除 App 數據**：

   ```bash
   adb shell pm clear com.safenet.app
   ```

2. **重新運行 App**：

   ```bash
   cd /Users/danielkai/Desktop/safe-net/apps/mobile
   npx expo run:android --device
   ```

3. **測試流程**：

   - ✅ 註冊新帳號
   - ✅ 查看「追蹤」頁面 → 顯示「尚無長輩資料」
   - ✅ 查看「警報」頁面 → 顯示「暫無警報」
   - ✅ 查看「個人」頁面 → 顯示用戶資料和「尚未加入任何社區」
   - ✅ 點擊「加入社區」→ 看到社區清單
   - ✅ 申請加入社區 → 成功提交

4. **預期結果**：
   - ❌ 不再看到 401 錯誤
   - ✅ 所有頁面正常顯示
   - ✅ 空白狀態有友善的提示文字

---

## 📊 修復前後對比

### 修復前 ❌

```
App 登入 ✓
   ↓
查看長輩清單 → 401 Unauthorized ✗
查看警報清單 → 401 Unauthorized ✗
查看個人資料 → 401 Unauthorized ✗
```

### 修復後 ✅

```
App 登入 ✓
   ↓
查看長輩清單 → 200 OK { data: [] } ✓
查看警報清單 → 200 OK { data: [] } ✓
查看個人資料 → 200 OK { user: {...}, tenants: [] } ✓
```

---

## 🔍 驗證修復是否生效

### 檢查後端日誌

重啟後，當 App 訪問 API 時，應該看到：

```
[JwtAuthGuard] Skipping App route: /api/app/elders
[JwtAppStrategy] Validating payload: { sub: '...', email: '...' }
[JwtAppStrategy] User found: { found: true, isActive: true }
```

### 檢查 API 響應

```bash
# 應該返回 200，而不是 401
curl http://localhost:3001/api/app/elders \
  -H "Authorization: Bearer <token>" \
  -s | jq '.statusCode // 200'

# 預期輸出: 200
```

---

## 🛠️ 技術細節

### 修復原理

```
修復前（全局 Guard 攔截所有路由）：
┌─────────────────────────────────┐
│ Request: /api/app/elders        │
│ Token: signed with JWT_APP_SECRET
├─────────────────────────────────┤
│ ① Global JwtAuthGuard           │
│    ├─ Strategy: 'jwt'            │
│    ├─ Secret: JWT_SECRET ✗      │
│    └─ Result: 401 ✗             │
│                                 │
│ Controller 永遠不會執行          │
└─────────────────────────────────┘

修復後（跳過 App 路由）：
┌─────────────────────────────────┐
│ Request: /api/app/elders        │
│ Token: signed with JWT_APP_SECRET
├─────────────────────────────────┤
│ ① Global JwtAuthGuard           │
│    ├─ 檢查: startsWith('/api/app/') │
│    └─ Result: 跳過 ✓            │
├─────────────────────────────────┤
│ ② Controller JwtAppAuthGuard    │
│    ├─ Strategy: 'jwt-app'        │
│    ├─ Secret: JWT_APP_SECRET ✓  │
│    └─ Result: 驗證成功 ✓        │
├─────────────────────────────────┤
│ ③ Service Layer                 │
│    └─ 返回資料 ✓                │
└─────────────────────────────────┘
```

### 安全性說明

- ✅ App 路由仍然受到 `JwtAppAuthGuard` 保護
- ✅ 後台路由繼續受到全局 Guard 保護
- ✅ 兩個系統完全獨立，互不干擾
- ✅ 不存在安全漏洞

---

## 📚 相關文檔

| 文件                                   | 用途                   |
| -------------------------------------- | ---------------------- |
| `APP_TOKEN_FIX.md`                     | 問題完整分析和技術細節 |
| `RESTART_AND_TEST.md`                  | 重啟和測試的詳細步驟   |
| `test-app-api.sh`                      | 自動化測試腳本         |
| `MOBILE_APP_API_REFERENCE.md`          | App API 完整參考       |
| `SYSTEM_ARCHITECTURE_CLARIFICATION.md` | 系統架構說明           |

---

## ❓ 常見問題

### Q: 為什麼需要重啟服務？

A: NestJS 的 Guard 在應用啟動時註冊，不支持熱重載。必須重啟才能載入新的 Guard 邏輯。

### Q: 如果測試還是失敗怎麼辦？

A: 參考 `RESTART_AND_TEST.md` 的「如果還是失敗」章節，檢查：

1. 服務是否真的重啟了
2. 修改是否正確應用
3. 環境變數是否正確設置

### Q: 會影響後台管理系統嗎？

A: 不會！後台使用不同的認證系統，完全獨立運作。

### Q: 用戶沒加入社區會怎樣？

A: 正常返回空陣列 `{ data: [], meta: {...} }`，不會報錯。

---

## 🎉 預期成果

修復完成後，整個系統應該這樣運作：

### 後台管理系統（不受影響）

- ✅ 正常登入
- ✅ 管理社區、長輩、設備等
- ✅ 查看警報
- ✅ 批准 App 用戶加入社區

### Mobile App（修復完成）

- ✅ 正常註冊/登入
- ✅ 查看各種清單（未加入社區時顯示空白）
- ✅ 申請加入社區
- ✅ 管理員批准後可以看到長輩和警報
- ✅ 接受和處理警報

---

**準備好了嗎？** 立即執行第 1 步：重啟後端服務！ 🚀

```bash
# 停止當前服務（在運行 pnpm dev 的終端按 Ctrl+C）
# 然後重新啟動：
cd /Users/danielkai/Desktop/safe-net
pnpm dev
```
