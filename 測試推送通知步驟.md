# 🧪 測試推送通知完整步驟

## ⚠️ 重要：API 路徑已修復

前端 API 路徑已更新為：
- ✅ `/app/push/register` （註冊 Token）
- ✅ `/app/push/token/:token` （移除 Token）

---

## 🚀 完整測試流程

### 步驟 1：重啟後端
```bash
cd apps/backend
pnpm dev
```

**確認後端啟動成功**：
- ✅ 看到 "🚀 Server: http://localhost:3001/api"
- ✅ 沒有錯誤訊息

---

### 步驟 2：重新載入 Mobile App
```bash
# 在 Expo 終端按 'r' 重新載入
# 或完全重啟：
cd apps/mobile
npx expo start --clear
```

---

### 步驟 3：登入並註冊 Push Token

1. 在 App 中登入（使用任一測試帳號）

2. **查看 App 日誌**（重要！）：
   - 應該看到：
     ```
     [authStore] 註冊推送通知...
     📢 初始化通知服務...
     ✅ 通知服務初始化成功
     ✅ Push Token 已獲取: ExponentPushToken[xxxxxx]
     [ApiClient] POST request: { url: '/app/push/register', ... }
     [ApiClient] POST success: { url: '/app/push/register', status: 200 }
     [authStore] ✅ Push Token 已註冊到後端
     ```

3. **如果看到錯誤**：
   - 檢查是否授予了通知權限
   - 檢查後端是否運行
   - 查看後端日誌

---

### 步驟 4：驗證 Token 已註冊

#### 方法 A：查看後端日誌
應該看到：
```
[PushNotificationsController] Register token for user: cmkgfo0tm0000qah8su6odbg9
[PushNotificationsService] Token registered successfully
```

#### 方法 B：查看資料庫
```bash
pnpm db:studio
```

打開 `push_tokens` 表，確認：
- ✅ 有一筆新記錄
- ✅ `appUserId` 是您的用戶 ID
- ✅ `token` 欄位有值（ExponentPushToken[...]）
- ✅ `isActive` 為 true

---

### 步驟 5：創建測試警報

```bash
pnpm test:alert 4
```

---

### 步驟 6：管理員分配警報

1. **確保以管理員身份登入**（例如：Kai）

2. 進入「緊急通知」→ 切換到「所有警報」

3. 找到新創建的測試警報（🧪 緊急求助）

4. 點擊進入詳情

5. 向下滾動，找到「分配狀態」卡片

6. 點擊「分配警報」按鈕

7. 在彈出的 Modal 中：
   - ✅ 看到社區成員列表
   - 選擇 1-2 位成員（可多選）
   - 點擊「確認分配」

8. **查看後端日誌**（重要！）：
   應該看到：
   ```
   [AppAlertsService] Assigning alert to 2 users
   [PushNotificationsService] Sending push notification to 2 devices: EMERGENCY 警報
   [PushNotificationsService] Sent 2 notifications
   [PushNotificationsService] Push notification results: 2 success, 0 errors
   ```

---

### 步驟 7：檢查是否收到通知

#### 測試前景通知（App 開啟）
- ✅ 頂部應該出現通知橫幅
- ✅ 顯示警報標題和內容
- ✅ 有聲音和震動

#### 測試背景通知（App 在背景）
1. 將 App 切換到背景（按 Home 鍵）
2. 創建新警報並分配
3. ✅ 通知中心應該顯示通知
4. 點擊通知應該打開 App

#### 測試離線通知（App 關閉）
1. 完全關閉 App
2. 創建新警報並分配
3. ✅ 應該收到系統通知
4. 點擊通知應該啟動 App

---

## 🐛 如果沒有收到通知

### 檢查清單

#### 1. Push Token 是否註冊成功？

**檢查 App 日誌**：
```
[authStore] ✅ Push Token 已註冊到後端
```

**檢查資料庫**：
```bash
pnpm db:studio
# 查看 push_tokens 表是否有記錄
```

**如果沒有**：
- 重新登入 App
- 查看是否有錯誤訊息
- 確認通知權限已授予

---

#### 2. 後端是否發送成功？

**檢查後端日誌**：
```
[PushNotificationsService] Sending push notification to 2 devices
[PushNotificationsService] Push notification results: 2 success, 0 errors
```

**如果看到錯誤**：
- 檢查 Token 格式是否正確
- 確認 expo-server-sdk 已安裝
- 重啟後端

---

#### 3. 手機通知權限是否開啟？

**Android**：
- 設定 → 應用程式 → Safe-Net → 通知
- 確保「允許通知」已開啟
- 檢查各個通知頻道是否開啟

**iOS**：
- 設定 → 通知 → Safe-Net
- 確保「允許通知」已開啟
- 檢查聲音、橫幅、鎖定螢幕等選項

---

#### 4. Expo Push Token 格式是否正確？

**正確格式**：
```
ExponentPushToken[xxxxxxxxxxxxxxxxxxxxxx]
```

**檢查方法**：
```bash
pnpm db:studio
# 查看 push_tokens 表的 token 欄位
```

---

## 🔍 詳細診斷步驟

### 診斷 1：檢查 Token 註冊

1. 開啟 App
2. 登入
3. 查看 Metro Bundler 日誌（Expo 終端）
4. 搜尋關鍵字：
   - `註冊推送通知`
   - `Push Token`
   - `POST /app/push/register`

**應該看到**：
```
[authStore] 註冊推送通知...
📢 初始化通知服務...
✅ 通知服務初始化成功
✅ Push Token 已獲取: ExponentPushToken[xxx]
[ApiClient] POST request: /app/push/register
[ApiClient] POST success
[authStore] ✅ Push Token 已註冊到後端
```

**如果看到錯誤**：
- 記下錯誤訊息
- 檢查後端是否運行
- 確認 API 路徑正確

---

### 診斷 2：檢查後端發送

1. 以管理員登入
2. 分配警報給成員
3. **立即查看後端終端**

**應該看到**：
```
[AppAlertsService] Assigning alert cmkgr84g40001jpckxgj754h0 to users
[PushNotificationsService] Sending push notification to 2 devices: EMERGENCY 警報
[PushNotificationsService] Sent 2 notifications
[PushNotificationsService] Push notification results: 2 success, 0 errors
```

**如果沒有看到**：
- 推送通知功能可能沒有被調用
- 檢查 Token 是否存在

---

### 診斷 3：手動測試推送通知

創建測試腳本來手動發送通知：

```bash
# 在終端執行
curl -X POST http://localhost:3001/api/app/push/register \
  -H "Content-Type: application/json" \
  -H "Authorization: Bearer YOUR_TOKEN" \
  -d '{
    "token": "ExponentPushToken[YOUR_PUSH_TOKEN]",
    "deviceInfo": {"platform": "test"}
  }'
```

---

## 💡 快速修復方案

### 方案 1：確認權限

1. 在 App 中手動請求權限：
   ```typescript
   // 在登入後執行
   const { status } = await Notifications.requestPermissionsAsync();
   console.log('通知權限狀態:', status);
   ```

2. 如果權限被拒絕，引導用戶到設定：
   ```typescript
   if (status !== 'granted') {
     Alert.alert(
       '需要通知權限',
       '請在設定中開啟通知權限以接收警報',
       [
         { text: '取消' },
         { text: '前往設定', onPress: () => Linking.openSettings() }
       ]
     );
   }
   ```

---

### 方案 2：使用本地通知測試

如果推送通知還在調試，可以先用本地通知測試功能：

在分配警報時，在前端手動觸發本地通知：

```typescript
// 在 AlertListScreen 中
useEffect(() => {
  // 監聽警報更新
  const subscription = apiClient.subscribe('/app/alerts', (newAlert) => {
    // 收到新分配的警報
    notificationService.sendAlertNotification(
      newAlert.title,
      newAlert.message,
      { alertId: newAlert.id }
    );
  });
  
  return () => subscription.unsubscribe();
}, []);
```

---

### 方案 3：使用 Expo Notifications 測試工具

1. 獲取 Push Token：
   ```typescript
   const token = await Notifications.getExpoPushTokenAsync();
   console.log('Token:', token.data);
   ```

2. 使用 Expo Push Notification Tool 測試：
   - 訪問：https://expo.dev/notifications
   - 輸入 Token
   - 發送測試通知
   - 確認手機能收到

---

## 🧪 簡化測試步驟

### 最簡單的測試方式

1. **確認後端運行**：
   ```bash
   curl http://localhost:3001/api
   ```

2. **登入 App**，查看日誌確認 Token 註冊

3. **創建測試警報**：
   ```bash
   pnpm test:alert 4
   ```

4. **在 App 中分配警報**

5. **查看後端日誌** - 關鍵！
   - 如果看到「Sent X notifications」，說明後端已發送
   - 如果沒收到，問題在 Expo Push 服務或手機設定

---

## 📱 替代方案：先用本地通知

在推送通知調試期間，可以先實現本地通知作為臨時方案：

修改 `AlertListScreen.tsx` 添加輪詢：

```typescript
useEffect(() => {
  // 每 30 秒檢查一次新警報
  const interval = setInterval(async () => {
    const response = await alertsApi.getMyAlerts();
    const newAlerts = response.data?.data || [];
    
    // 檢查是否有新警報
    const currentIds = alerts.map(a => a.id);
    const newOnes = newAlerts.filter(a => !currentIds.includes(a.id));
    
    // 顯示本地通知
    newOnes.forEach(alert => {
      notificationService.sendAlertNotification(
        alert.title,
        alert.message,
        { alertId: alert.id }
      );
    });
  }, 30000);
  
  return () => clearInterval(interval);
}, [alerts]);
```

---

## 🎯 下一步

請先執行診斷：

1. **重新登入 App**
2. **仔細查看 App 日誌**（重要！）
3. **記下任何錯誤訊息**
4. **查看後端日誌**
5. **檢查 push_tokens 表**

然後告訴我：
- 是否看到「Push Token 已註冊到後端」？
- 分配警報時後端是否顯示「Sent X notifications」？
- 資料庫中是否有 Push Token 記錄？

根據這些資訊，我可以進一步幫您排查問題！

---

**讓我們一步步找出問題！** 🔍
