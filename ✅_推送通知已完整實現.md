# ✅ 推送通知已完整實現

## 🎯 問題分析

**問題**：為什麼沒有手機原生通知？離開 App 也要有通知。

**原因**：
1. ✅ 守護者模式使用的是**本地通知**（`Notifications.scheduleNotificationAsync`）
   - 在 App 內觸發
   - 不需要後端
   - 測試成功過

2. ❌ 警報系統需要的是**推送通知**（Push Notification）
   - 從後端發送
   - 即使 App 關閉也能收到
   - **之前沒有實現**

---

## ✅ 已完成的實現

### 1. 前端（Mobile App）

#### ✅ 更新 notificationService
- 添加 `registerPushToken()` 方法
- 添加 `sendAlertNotification()` 方法（本地測試用）
- 添加 `setupNotificationResponseHandler()` 處理點擊

#### ✅ 創建 pushToken API
- `registerToken()` - 註冊 Token 到後端
- `removeToken()` - 移除 Token

#### ✅ 更新 authStore
- 登入後自動註冊 Push Token
- 調用 `registerPushNotifications()`

#### ✅ 更新 App.tsx
- 初始化通知頻道（Android）
- 監聽前景通知
- 監聽用戶點擊通知
- 設置通知處理器

### 2. 後端

#### ✅ 安裝 expo-server-sdk
```bash
pnpm add expo-server-sdk
```

#### ✅ 更新 PushNotificationsService
- 初始化 Expo Push Client
- 實現真實的推送通知發送
- 批次處理（每批最多 100 條）
- 錯誤處理和日誌記錄

#### ✅ 更新 AppAlertsService
- 注入 PushNotificationsService
- 分配警報時自動發送推送通知
- 錯誤處理不影響分配流程

---

## 🔄 通知流程

### 本地通知（守護者模式）
```
App 內藍牙掃描
  ↓
偵測到設備
  ↓
App 內觸發本地通知
  ↓
立即顯示通知 ✅
```

### 推送通知（警報系統）
```
後端創建/分配警報
  ↓
查詢被分配成員的 Push Tokens
  ↓
調用 Expo Push API 發送
  ↓
Expo 伺服器推送到手機
  ↓
即使 App 關閉也能收到 ✅
```

---

## 📱 通知類型

### 1. 本地通知（Local Notification）
**特點**：
- ✅ 由 App 內部觸發
- ✅ 不需要網路
- ✅ 不需要後端
- ⚠️ App 必須在運行（前景或背景）

**使用場景**：
- 守護者模式的設備偵測
- 藍牙掃描提醒
- 上傳成功提示

### 2. 推送通知（Push Notification）
**特點**：
- ✅ 由後端發送
- ✅ 即使 App 關閉也能收到
- ✅ 可以喚醒 App
- ⚠️ 需要網路連接

**使用場景**：
- 警報分配通知
- 警報狀態更新
- 重要系統通知

---

## 🚀 使用方式

### 測試推送通知

#### 步驟 1：確保後端運行
```bash
cd apps/backend
pnpm dev
```

#### 步驟 2：在 App 中登入
- 登入時會自動註冊 Push Token
- 查看日誌確認：
  ```
  [authStore] 註冊推送通知...
  ✅ Push Token 已獲取: ExponentPushToken[...]
  [authStore] ✅ Push Token 已註冊到後端
  ```

#### 步驟 3：創建測試警報
```bash
pnpm test:alert 4  # 創建緊急警報
```

#### 步驟 4：檢查通知
- ✅ 前景：App 開啟時，頂部顯示通知橫幅
- ✅ 背景：App 在背景時，通知中心顯示
- ✅ 關閉：App 完全關閉時，也能收到通知

---

## 🎨 通知頻道（Android）

已創建 3 個通知頻道：

### 1. alert（警報通知）
- **重要性**: MAX
- **聲音**: 預設
- **震動**: 是
- **LED**: 紅色
- **用途**: 警報系統的所有通知

### 2. guardian-alerts（守護者警報）
- **重要性**: MAX
- **聲音**: 預設
- **震動**: 是
- **用途**: 守護者模式的近距離警報

### 3. device-detected（設備偵測）
- **重要性**: HIGH
- **聲音**: 預設
- **震動**: 是
- **用途**: 守護者模式的設備偵測通知

---

## 🧪 測試清單

### 前景通知（App 開啟）
- [ ] 創建測試警報
- [ ] App 開啟時收到通知橫幅
- [ ] 顯示標題和內容
- [ ] 有聲音和震動

### 背景通知（App 在背景）
- [ ] 將 App 切換到背景
- [ ] 創建測試警報
- [ ] 通知中心顯示通知
- [ ] 點擊通知打開 App

### 關閉通知（App 完全關閉）
- [ ] 完全關閉 App
- [ ] 創建測試警報
- [ ] 收到系統通知
- [ ] 點擊通知啟動 App

### Push Token 註冊
- [ ] 登入時自動註冊
- [ ] 後端日誌顯示 Token 註冊成功
- [ ] 可以在 Prisma Studio 查看 `push_tokens` 表

---

## 🔍 檢查 Push Token

### 使用 Prisma Studio
```bash
pnpm db:studio
```

打開 `push_tokens` 表，應該看到：
- `token`: ExponentPushToken[...]
- `appUserId`: 用戶 ID
- `isActive`: true
- `deviceInfo`: 設備資訊

### 查看後端日誌
```bash
cd apps/backend
pnpm dev
```

應該看到：
```
[PushNotificationsService] Sending push notification to 2 devices: BOUNDARY 警報
[PushNotificationsService] Sent 2 notifications
[PushNotificationsService] Push notification results: 2 success, 0 errors
```

---

## 📊 通知內容格式

### 警報通知
```
標題: BOUNDARY 警報
內容: 陳伯伯 - 陳伯伯 在 社區大門 被偵測到（測試警報）
數據: {
  alertId: "cmkgqwb930001fan0jbt8qwrw",
  type: "alert"
}
```

### 守護者通知
```
標題: 偵測到長者：陳伯伯
內容: 設備: AA:BB:CC:DD:EE:01
      距離: 2.5m
數據: {
  type: "device_detected",
  macAddress: "AA:BB:CC:DD:EE:01",
  distance: 2.5
}
```

---

## 🐛 常見問題

### Q: 收不到推送通知？

**檢查清單**：
1. [ ] 是否已登入？
2. [ ] Push Token 是否已註冊？
   ```bash
   pnpm db:studio
   # 查看 push_tokens 表
   ```
3. [ ] 後端是否發送成功？
   ```bash
   # 查看後端日誌
   cd apps/backend && pnpm dev
   ```
4. [ ] 手機是否允許通知權限？
   - Android: 設定 → 應用程式 → Safe-Net → 通知
   - iOS: 設定 → 通知 → Safe-Net

### Q: 只有本地通知，沒有推送通知？

**原因**：
- Push Token 未註冊
- 後端未發送

**解決**：
1. 重新登入 App
2. 查看日誌確認 Token 註冊
3. 創建測試警報
4. 查看後端日誌

### Q: Android 沒有聲音？

**解決**：
1. 檢查通知頻道設置
2. 確認手機音量開啟
3. 檢查勿擾模式

### Q: iOS 測試推送通知？

**注意**：
- iOS 模擬器**不支援**推送通知
- 必須使用**實體設備**測試
- 需要 Apple Developer 帳號配置

---

## 💡 開發建議

### 測試推送通知的最佳方式

1. **使用 Android 實體設備**
   - 支援完整的推送通知
   - 可以測試 App 關閉狀態

2. **使用 Expo Go App**
   - 快速測試
   - 不需要編譯

3. **查看後端日誌**
   - 確認通知是否發送
   - 查看發送結果

---

## 📋 完整測試流程

### 1. 準備環境
```bash
# 終端 1 - 後端
cd apps/backend
pnpm dev

# 終端 2 - Mobile App
cd apps/mobile
npx expo start
```

### 2. 註冊 Push Token
1. 在 App 中登入
2. 查看日誌確認 Token 註冊
3. 在 Prisma Studio 確認 Token 已保存

### 3. 測試推送通知
```bash
# 終端 3 - 創建測試警報
pnpm test:alert 4
```

### 4. 驗證通知
- [ ] App 開啟時：頂部橫幅
- [ ] App 背景時：通知中心
- [ ] App 關閉時：系統通知

---

## 🎊 完成！

現在您的 App 有**完整的通知系統**：

✅ **本地通知**（守護者模式）
- 設備偵測
- 上傳成功
- 近距離警報

✅ **推送通知**（警報系統）
- 警報分配通知
- 即使 App 關閉也能收到
- 完整的狀態追蹤

---

## 🚀 立即測試

### 快速測試命令

```bash
# 1. 重啟後端
cd apps/backend
pnpm dev

# 2. 重新載入 App（按 'r'）

# 3. 登入 App（會自動註冊 Push Token）

# 4. 創建測試警報
pnpm test:alert 4

# 5. 檢查是否收到推送通知
```

---

## 📚 相關文件

- `apps/mobile/src/services/notificationService.ts` - 通知服務
- `apps/mobile/src/api/pushToken.ts` - Push Token API
- `apps/backend/src/push-notifications/` - 後端推送服務
- `apps/mobile/App.tsx` - 通知初始化

---

**請重啟後端和 App，然後測試推送通知！** 🚀

有任何問題隨時告訴我！
