# ğŸš€ å¿«é€Ÿé–‹å§‹ï¼šApp æ¸¬è©¦æŒ‡å—

**æ›´æ–°æ™‚é–“**: 2026-01-16 15:05  
**ç‹€æ…‹**: Token é©—è­‰å•é¡Œå·²ä¿®å¾©ï¼Œéœ€è¦é‡å•Ÿæ¸¬è©¦

---

## âš¡ 3 æ­¥é©Ÿå¿«é€Ÿæ¸¬è©¦

### æ­¥é©Ÿ 1ï¸âƒ£ï¼šé‡å•Ÿå¾Œç«¯æœå‹™

```bash
# æ–¹å¼ Aï¼šåœ¨é‹è¡Œ pnpm dev çš„çµ‚ç«¯æŒ‰ Ctrl+Cï¼Œç„¶å¾Œï¼š
cd /Users/danielkai/Desktop/safe-net
pnpm dev

# æ–¹å¼ Bï¼šä½¿ç”¨å‘½ä»¤é‡å•Ÿ
pkill -f "pnpm dev" && sleep 2 && cd /Users/danielkai/Desktop/safe-net && pnpm dev
```

â±ï¸ ç­‰å¾…æœå‹™å•Ÿå‹•ï¼ˆç´„ 10-20 ç§’ï¼‰

### æ­¥é©Ÿ 2ï¸âƒ£ï¼šé‹è¡Œè‡ªå‹•åŒ–æ¸¬è©¦

```bash
cd /Users/danielkai/Desktop/safe-net
./test-app-api.sh
```

**é æœŸè¼¸å‡º**ï¼š
```
âœ“ æ‰€æœ‰æ¸¬è©¦é€šéï¼

App API ä¿®å¾©æˆåŠŸï¼ç¾åœ¨å¯ä»¥ï¼š
1. âœ“ æ­£å¸¸è¨»å†Š/ç™»å…¥
2. âœ“ æŸ¥çœ‹é•·è¼©æ¸…å–®
3. âœ“ æŸ¥çœ‹è­¦å ±æ¸…å–®
4. âœ“ æŸ¥çœ‹ç¤¾å€æ¸…å–®
5. âœ“ æŸ¥çœ‹å€‹äººè³‡æ–™
6. âœ“ æŸ¥çœ‹å·²åŠ å…¥çš„ç¤¾å€
```

### æ­¥é©Ÿ 3ï¸âƒ£ï¼šæ¸¬è©¦ Mobile App

```bash
# æ¸…é™¤ App æ•¸æ“š
adb shell pm clear com.safenet.app

# é‡æ–°é‹è¡Œ App
cd /Users/danielkai/Desktop/safe-net/apps/mobile
npx expo run:android --device
```

**åœ¨ App ä¸­æ¸¬è©¦**ï¼š
1. è¨»å†Šæ–°å¸³è™Ÿ
2. æª¢æŸ¥ã€Œè¿½è¹¤ã€é é¢ â†’ é¡¯ç¤ºã€Œå°šç„¡é•·è¼©è³‡æ–™ã€
3. æª¢æŸ¥ã€Œè­¦å ±ã€é é¢ â†’ é¡¯ç¤ºã€Œæš«ç„¡è­¦å ±ã€
4. æª¢æŸ¥ã€Œå€‹äººã€é é¢ â†’ é¡¯ç¤ºç”¨æˆ¶è³‡æ–™
5. é»æ“Šã€ŒåŠ å…¥ç¤¾å€ã€â†’ çœ‹åˆ°ç¤¾å€æ¸…å–®

---

## âœ… æˆåŠŸæ¨™èªŒ

### å¾Œç«¯æ—¥èªŒé¡¯ç¤ºï¼š
```
[JwtAuthGuard] Skipping App route: /api/app/elders
[JwtAppStrategy] Validating payload: { sub: '...', email: '...' }
[JwtAppStrategy] User found: { found: true, isActive: true }
```

### App è¡Œç‚ºï¼š
- âœ… ä¸å†çœ‹åˆ° 401 éŒ¯èª¤
- âœ… æ‰€æœ‰é é¢æ­£å¸¸è¼‰å…¥
- âœ… ç©ºç™½ç‹€æ…‹æœ‰å‹å–„æç¤º

---

## ğŸ” å¦‚æœæ¸¬è©¦å¤±æ•—

### æª¢æŸ¥ 1ï¼šæœå‹™æ˜¯å¦çœŸçš„é‡å•Ÿäº†ï¼Ÿ

```bash
ps aux | grep "pnpm dev"
# æ‡‰è©²çœ‹åˆ°æ–°çš„é€²ç¨‹ ID
```

### æª¢æŸ¥ 2ï¼šä¿®æ”¹æ˜¯å¦ç”Ÿæ•ˆï¼Ÿ

```bash
cat /Users/danielkai/Desktop/safe-net/apps/backend/src/auth/guards/jwt-auth.guard.ts | grep "startsWith"
# æ‡‰è©²çœ‹åˆ°ï¼šif (request.url?.startsWith('/api/app/'))
```

### æª¢æŸ¥ 3ï¼šç’°å¢ƒè®Šæ•¸æ˜¯å¦æ­£ç¢ºï¼Ÿ

```bash
cd /Users/danielkai/Desktop/safe-net/apps/backend
cat .env | grep JWT
# æ‡‰è©²çœ‹åˆ°ï¼š
# JWT_SECRET=...
# JWT_APP_SECRET=...
```

---

## ğŸ“Š ä¿®å¾©å…§å®¹ç¸½çµ

### å•é¡Œ
å…¨å±€ `JwtAuthGuard` æœƒæ””æˆªæ‰€æœ‰è·¯ç”±ï¼ˆåŒ…æ‹¬ `/api/app/*`ï¼‰ï¼Œä½¿ç”¨éŒ¯èª¤çš„ secret é©—è­‰ App tokenï¼Œå°è‡´ 401ã€‚

### è§£æ±ºæ–¹æ¡ˆ
ä¿®æ”¹å…¨å±€ Guardï¼Œè®“å®ƒè·³é App è·¯ç”±ï¼š

```typescript
// åœ¨ jwt-auth.guard.ts ä¸­æ·»åŠ 
if (request.url?.startsWith('/api/app/')) {
  return true;  // è·³éï¼Œè®“ JwtAppAuthGuard è™•ç†
}
```

### å½±éŸ¿
- âœ… ä¿®å¾© App API çš„ 401 å•é¡Œ
- âœ… ä¸å½±éŸ¿å¾Œå°ç®¡ç†ç³»çµ±
- âœ… ä¿æŒå®‰å…¨æ€§

---

## ğŸ“š è©³ç´°æ–‡æª”

| æ–‡ä»¶ | èªªæ˜ |
|------|------|
| `ä¿®å¾©å®Œæˆ_è«‹é‡å•Ÿæ¸¬è©¦.md` | å®Œæ•´çš„ä¿®å¾©èªªæ˜å’Œæ¸¬è©¦æŒ‡å— â­ æ¨è–¦é–±è®€ |
| `APP_TOKEN_FIX.md` | æŠ€è¡“ç´°ç¯€å’Œå•é¡Œåˆ†æ |
| `test-app-api.sh` | è‡ªå‹•åŒ–æ¸¬è©¦è…³æœ¬ |
| `RESTART_AND_TEST.md` | è©³ç´°çš„é‡å•Ÿå’Œæ¸¬è©¦æ­¥é©Ÿ |

---

## ğŸ’¬ éœ€è¦å¹«åŠ©ï¼Ÿ

å¦‚æœé‡åˆ°å•é¡Œï¼š
1. å…ˆæŸ¥çœ‹ `ä¿®å¾©å®Œæˆ_è«‹é‡å•Ÿæ¸¬è©¦.md`
2. æª¢æŸ¥å¾Œç«¯çµ‚ç«¯çš„éŒ¯èª¤æ—¥èªŒ
3. ç¢ºèªç’°å¢ƒè®Šæ•¸è¨­ç½®æ­£ç¢º

---

**æº–å‚™å¥½äº†å—ï¼Ÿå¾æ­¥é©Ÿ 1 é–‹å§‹å§ï¼** ğŸš€
