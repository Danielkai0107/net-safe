# 🔧 推送通知問題解決方案

## ⚠️ 問題診斷

### 錯誤訊息
```
ERROR ❌ 註冊 Push Token 失敗: 
Default FirebaseApp is not initialized in this process com.safenet.app. 
Make sure to call FirebaseApp.initializeApp(Context) first.
```

### 問題原因
Android 的推送通知需要 **Firebase Cloud Messaging (FCM)** 配置。

Expo 在 Android 上使用 FCM 來發送推送通知，但您的 App 還沒有配置 Firebase。

---

## 🎯 解決方案（3 選 1）

### 方案 1️⃣：使用 Expo Go 測試（最快速）⭐

**優點**：
- ✅ 無需配置 Firebase
- ✅ 立即可以測試
- ✅ 3 分鐘內搞定

**步驟**：

1. **安裝 Expo Go App**
   - Android: Google Play Store 搜尋 "Expo Go"
   - iOS: App Store 搜尋 "Expo Go"

2. **啟動 Expo 開發伺服器**
   ```bash
   cd apps/mobile
   npx expo start
   ```

3. **掃描 QR Code**
   - 使用 Expo Go App 掃描終端顯示的 QR Code
   - 或在同一 WiFi 下自動連接

4. **測試推送通知**
   - 在 Expo Go 中登入
   - Push Token 會自動註冊
   - 分配警報測試通知

**限制**：
- 只能用於開發測試
- 無法測試完整的 native 功能

---

### 方案 2️⃣：配置 Firebase（完整方案）

**優點**：
- ✅ 支援所有功能
- ✅ 可以發布到商店

**步驟**：

#### A. 創建 Firebase 專案

1. 訪問 https://console.firebase.google.com/
2. 點擊「新增專案」
3. 輸入專案名稱：`Safe-Net`
4. 完成創建

#### B. 添加 Android App

1. 在 Firebase Console，點擊 Android 圖示
2. 輸入套件名稱：`com.safenet.app`（與 app.json 中的相同）
3. 下載 `google-services.json`
4. 將文件放到：`apps/mobile/android/app/google-services.json`

#### C. 獲取 FCM Server Key

1. Firebase Console → 專案設定 → 雲端通訊
2. 複製「伺服器金鑰」
3. 稍後會用到

#### D. 配置 Expo

方法 A - 使用 EAS（推薦）：
```bash
# 安裝 EAS CLI
npm install -g eas-cli

# 登入 Expo
eas login

# 配置專案
cd apps/mobile
eas build:configure
```

在 `eas.json` 中添加：
```json
{
  "build": {
    "development": {
      "android": {
        "gradleCommand": ":app:assembleDebug",
        "credentialsSource": "local"
      }
    }
  }
}
```

方法 B - 手動配置：

1. 編輯 `app.json`：
```json
{
  "expo": {
    "android": {
      "googleServicesFile": "./google-services.json",
      "package": "com.safenet.app"
    },
    "extra": {
      "eas": {
        "projectId": "your-expo-project-id"
      }
    }
  }
}
```

2. 安裝依賴：
```bash
cd apps/mobile
npx expo install expo-notifications
npx expo prebuild --clean
```

3. 重新編譯：
```bash
npx expo run:android
```

---

### 方案 3️⃣：臨時方案 - 使用本地通知模擬（最快測試功能）

**優點**：
- ✅ 無需任何配置
- ✅ 立即可測試功能邏輯
- ✅ 5 分鐘內完成

**缺點**：
- ⚠️ 不是真正的推送通知
- ⚠️ App 必須在運行

**實現**：

在 `AlertListScreen.tsx` 添加輪詢檢查新警報：

```typescript
import { notificationService } from '../../services/notificationService';

export function AlertListScreen({ navigation }: any) {
  // ... 現有代碼
  
  useEffect(() => {
    // 初始化通知服務
    notificationService.initialize();
    
    // 每 10 秒檢查一次新警報
    const interval = setInterval(async () => {
      try {
        const response: any = await alertsApi.getMyAlerts();
        const newAlerts = response.data?.data || [];
        
        // 找出新警報（在當前列表中沒有的）
        const currentIds = alerts.map((a) => a.id);
        const newOnes = newAlerts.filter((a: any) => !currentIds.includes(a.id));
        
        // 為每個新警報發送本地通知
        for (const alert of newOnes) {
          await notificationService.sendAlertNotification(
            alert.title || '新警報',
            alert.message,
            { alertId: alert.id, type: 'alert' }
          );
        }
        
        // 更新列表
        if (newOnes.length > 0) {
          console.log(`📬 收到 ${newOnes.length} 個新警報`);
          setAlerts(newAlerts);
        }
      } catch (error) {
        // 靜默失敗，不影響正常使用
      }
    }, 10000); // 每 10 秒
    
    return () => clearInterval(interval);
  }, [alerts]);
  
  // ... 其他代碼
}
```

---

## 🎯 推薦方案

### 立即測試功能（今天）
**使用方案 3**：本地通知 + 輪詢
- 5 分鐘實現
- 立即可測試分配、接受、婉拒等功能
- 雖然不是真正的推送，但功能邏輯完全相同

### 完整實現（週末）
**使用方案 2**：配置 Firebase
- 需要 Google 帳號
- 約 30 分鐘設置
- 支援真正的推送通知

### 快速驗證（替代）
**使用方案 1**：Expo Go
- 最簡單
- 可驗證推送通知是否能收到
- 但有功能限制

---

## 💡 我的建議

### 現在（立即）

**使用本地通知 + 輪詢**讓您能立即測試所有功能：

```typescript
// 我可以幫您實現，只需要修改 AlertListScreen.tsx
// 添加約 20 行代碼即可
```

### 週末（如果需要真正推送）

配置 Firebase FCM：
1. 創建 Firebase 專案（5 分鐘）
2. 下載 google-services.json（1 分鐘）
3. 重新編譯 App（10 分鐘）
4. 測試推送通知（5 分鐘）

---

## 🚀 快速決策

**如果您想：**

### A. 立即測試功能邏輯
→ 使用方案 3（本地通知）
→ 我可以立即幫您實現

### B. 完整的推送通知體驗
→ 使用方案 2（Firebase）
→ 需要您創建 Firebase 專案

### C. 快速驗證推送通知
→ 使用方案 1（Expo Go）
→ 安裝 Expo Go App 即可

---

**您想使用哪個方案？** 

我推薦先用**方案 3**立即測試功能，週末再配置 Firebase 實現真正的推送通知。