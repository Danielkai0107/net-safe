# Safe-Net ç³»çµ±æ¶æ§‹é‡æ¸…

**å‰µå»ºæ™‚é–“**: 2026-01-16  
**ç›®çš„**: é‡æ¸…ç”¨æˆ¶ç³»çµ±å’Œè³‡æ–™æµç¨‹

---

## ğŸ¯ ç”¨æˆ¶ç³»çµ±æ¶æ§‹

### å…©å€‹ç¨ç«‹çš„ç”¨æˆ¶ç³»çµ±

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    ç”¨æˆ¶ç³»çµ±æ¶æ§‹                          â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                         â”‚
â”‚  å¾Œå°ç®¡ç†å“¡ç³»çµ±ï¼ˆusers è¡¨ï¼‰                              â”‚
â”‚  â”œâ”€ è¨»å†Šæ–¹å¼ï¼šå¾Œå°ã€Œäººå“¡ç®¡ç†ã€ç”±ç®¡ç†å“¡æ–°å¢                â”‚
â”‚  â”œâ”€ ç™»å…¥å…¥å£ï¼šå¾Œå° Webï¼ˆhttp://localhost:5173ï¼‰         â”‚
â”‚  â”œâ”€ èªè­‰ï¼šJWT_SECRET                                    â”‚
â”‚  â”œâ”€ è§’è‰²ï¼šSUPER_ADMIN, TENANT_ADMIN, STAFF             â”‚
â”‚  â””â”€ æ¬Šé™ï¼šç®¡ç†å¾Œå°ç³»çµ±                                  â”‚
â”‚                                                         â”‚
â”‚  App ç”¨æˆ¶ç³»çµ±ï¼ˆapp_users è¡¨ï¼‰                           â”‚
â”‚  â”œâ”€ è¨»å†Šæ–¹å¼ï¼šMobile App è‡ªè¡Œè¨»å†Š                       â”‚
â”‚  â”œâ”€ ç™»å…¥å…¥å£ï¼šMobile App                                â”‚
â”‚  â”œâ”€ èªè­‰ï¼šJWT_APP_SECRET                               â”‚
â”‚  â”œâ”€ è§’è‰²ï¼šé€é tenant_members.roleï¼ˆMEMBER, ADMINï¼‰    â”‚
â”‚  â””â”€ æ¬Šé™ï¼šæŸ¥çœ‹å’Œè™•ç†ç¤¾å€è³‡æ–™                            â”‚
â”‚                                                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ“Š è³‡æ–™åº«è¡¨æ ¼é—œä¿‚

### 1. å¾Œå°ç®¡ç†å“¡ï¼ˆusersï¼‰

```sql
users
â”œâ”€ id, email, name, password
â”œâ”€ role: SUPER_ADMIN | TENANT_ADMIN | STAFF
â”œâ”€ tenantId: æ‰€å±¬ç¤¾å€ï¼ˆSUPER_ADMIN ç‚º nullï¼‰
â””â”€ ç®¡ç†ä½ç½®ï¼šå¾Œå° â†’ äººå“¡ç®¡ç†
```

### 2. App ç”¨æˆ¶ï¼ˆapp_usersï¼‰

```sql
app_users
â”œâ”€ id, email, name, password
â”œâ”€ phone, avatar, isActive
â””â”€ ç®¡ç†ä½ç½®ï¼š
    â”œâ”€ å¾Œå° â†’ ç¤¾å€ç®¡ç† â†’ ğŸ‘¥ App æˆå“¡ï¼ˆæŸ¥çœ‹å·²ç”³è«‹è©²ç¤¾å€çš„ç”¨æˆ¶ï¼‰
    â””â”€ æˆ–å»ºè­°æ–°å¢ï¼šå¾Œå° â†’ App ç”¨æˆ¶ç®¡ç†ï¼ˆæŸ¥çœ‹æ‰€æœ‰ App ç”¨æˆ¶ï¼‰
```

### 3. ç¤¾å€æˆå“¡é—œä¿‚ï¼ˆtenant_membersï¼‰

```sql
tenant_members
â”œâ”€ appUserId: App ç”¨æˆ¶ ID
â”œâ”€ tenantId: ç¤¾å€ ID
â”œâ”€ role: MEMBER | ADMINï¼ˆç¤¾å€å…§çš„è§’è‰²ï¼‰
â”œâ”€ status: PENDING | APPROVED | REJECTED
â””â”€ é€™æ˜¯ app_users å’Œ tenants çš„å¤šå°å¤šé—œè¯è¡¨
```

---

## ğŸ”„ æ­£ç¢ºçš„è³‡æ–™æµç¨‹

### App ç”¨æˆ¶çš„å®Œæ•´æµç¨‹

```
æ­¥é©Ÿ 1: è¨»å†Š
  ç”¨æˆ¶åœ¨ Mobile App è¨»å†Š
  â†“
  å‰µå»º app_users è¨˜éŒ„
  â†“
  ç”¨æˆ¶å¯ä»¥ç™»å…¥ App

æ­¥é©Ÿ 2: åŠ å…¥ç¤¾å€
  ç”¨æˆ¶åœ¨ Appã€Œå€‹äººã€â†’ã€ŒåŠ å…¥ç¤¾å€ã€
  â†“
  å‰µå»º tenant_members è¨˜éŒ„ï¼ˆstatus = PENDINGï¼‰
  â†“
  ç­‰å¾…ç®¡ç†å“¡æ‰¹å‡†

æ­¥é©Ÿ 3: æ‰¹å‡†
  å¾Œå°ç®¡ç†å“¡ï¼šç¤¾å€ç®¡ç† â†’ é»æ“Š ğŸ‘¥ â†’ æ‰¹å‡†
  æˆ–
  App ç®¡ç†å“¡ï¼šå€‹äºº â†’ ç­‰å¾…ç¢ºèªæ¸…å–® â†’ æ‰¹å‡†
  â†“
  tenant_members.status = APPROVED

æ­¥é©Ÿ 4: æŸ¥çœ‹è³‡æ–™
  ç”¨æˆ¶åœ¨ App æŸ¥çœ‹é•·è¼©ã€è­¦å ±ç­‰
  â†“
  å¾Œç«¯æª¢æŸ¥ï¼š
    - æŸ¥è©¢ tenant_membersï¼ˆappUserId + status=APPROVEDï¼‰
    - ç²å– tenantIds
    - å¦‚æœ tenantIds ç‚ºç©º â†’ è¿”å›ç©ºé™£åˆ—[]ï¼ˆä¸æ˜¯ 401ï¼‰
    - å¦‚æœæœ‰ tenantIds â†’ æŸ¥è©¢è©²ç¤¾å€çš„è³‡æ–™
```

---

## âœ… å·²è§£æ±ºçš„å•é¡Œï¼ˆ2026-01-16ï¼‰

### å•é¡Œ 1: App æŸ¥è©¢è¿”å› 401 âœ… å·²ä¿®å¾©

**ç¾è±¡**: ç”¨æˆ¶ç™»å…¥æˆåŠŸï¼Œä½†æŸ¥è©¢é•·è¼©/è­¦å ±/å€‹äººè³‡æ–™éƒ½è¿”å› 401

**é æœŸè¡Œç‚º**: æ‡‰è©²è¿”å›ç©ºé™£åˆ— `{ data: [], meta: {...} }` æˆ–ç”¨æˆ¶è³‡æ–™

**æ ¹æœ¬åŸå› **:

åœ¨ `app.module.ts` ä¸­è¨­ç½®äº†å…¨å±€çš„ `JwtAuthGuard`ï¼Œå®ƒæœƒæ””æˆª**æ‰€æœ‰è·¯ç”±**ï¼š

```typescript
providers: [
  {
    provide: APP_GUARD,
    useClass: JwtAuthGuard, // é€™æ˜¯å¾Œå°ç®¡ç†å“¡å°ˆç”¨çš„ Guardï¼
  },
];
```

å•é¡Œæµç¨‹ï¼š

1. App ç”¨æˆ¶ç™»å…¥ï¼Œå¾Œç«¯ç”¨ `JWT_APP_SECRET` ç”Ÿæˆ token
2. App ç™¼é€è«‹æ±‚åˆ° `/api/app/elders`ï¼Œå¸¶è‘—é€™å€‹ token
3. **å…¨å±€ JwtAuthGuard é¦–å…ˆæ””æˆª**ï¼ˆä½¿ç”¨ 'jwt' strategyï¼Œsecret æ˜¯ `JWT_SECRET`ï¼‰
4. å˜—è©¦ç”¨ `JWT_SECRET` é©—è­‰ token â†’ å¤±æ•—ï¼ï¼ˆtoken æ˜¯ç”¨ `JWT_APP_SECRET` ç°½åçš„ï¼‰
5. è¿”å› 401ï¼Œè«‹æ±‚é€£ Controller éƒ½åˆ°ä¸äº†

**ä¿®å¾©æ–¹æ¡ˆ**:

ä¿®æ”¹ `apps/backend/src/auth/guards/jwt-auth.guard.ts`ï¼š

```typescript
canActivate(context: ExecutionContext) {
  const isPublic = this.reflector.getAllAndOverride<boolean>(IS_PUBLIC_KEY, [
    context.getHandler(),
    context.getClass(),
  ]);

  if (isPublic) {
    return true;
  }

  // è·³é App ç›¸é—œè·¯ç”±ï¼ˆ/api/app/*ï¼‰ï¼Œè®“ JwtAppAuthGuard è™•ç†
  const request = context.switchToHttp().getRequest();
  if (request.url?.startsWith('/api/app/')) {
    return true;
  }

  return super.canActivate(context);
}
```

åŒæ¨£ä¿®æ”¹ `roles.guard.ts` è®“å®ƒä¹Ÿè·³é App è·¯ç”±ã€‚

**æ¸¬è©¦é©—è­‰**:

```bash
# åŸ·è¡Œè‡ªå‹•åŒ–æ¸¬è©¦
./test-app-api.sh

# é æœŸçµæœï¼šæ‰€æœ‰æ¸¬è©¦é€šéï¼Œè¿”å› 200 è€Œä¸æ˜¯ 401
```

**ç›¸é—œæ–‡æª”**: `APP_TOKEN_FIX.md`, `ä¿®å¾©å®Œæˆ_è«‹é‡å•Ÿæ¸¬è©¦.md`

---

### å•é¡Œ 2: å¾Œå°ç¼ºå°‘ã€ŒApp ç”¨æˆ¶ç®¡ç†ã€é é¢ âŒ

**ç¾æ³**:

- å¾Œå°æœ‰ã€Œäººå“¡ç®¡ç†ã€ï¼ˆç®¡ç† users è¡¨ï¼‰âœ…
- å¾Œå°æ²’æœ‰ã€ŒApp ç”¨æˆ¶ç®¡ç†ã€ï¼ˆç®¡ç† app_users è¡¨ï¼‰âŒ

**å»ºè­°æ–°å¢**:

```
å¾Œå° â†’ App ç”¨æˆ¶ç®¡ç†
â”œâ”€ åˆ—å‡ºæ‰€æœ‰ App ç”¨æˆ¶ï¼ˆapp_users è¡¨ï¼‰
â”œâ”€ æŸ¥çœ‹ç”¨æˆ¶è©³æƒ…
â”œâ”€ æŸ¥çœ‹ç”¨æˆ¶åŠ å…¥çš„ç¤¾å€
â”œâ”€ å•Ÿç”¨/åœç”¨ç”¨æˆ¶
â””â”€ åˆªé™¤ç”¨æˆ¶
```

---

## ğŸ¯ éœ€è¦ä¿®æ­£çš„åœ°æ–¹

### ä¿®æ­£ 1: ç¢ºä¿ Token æ­£ç¢ºä¿å­˜å’Œä½¿ç”¨

è®“æˆ‘æª¢æŸ¥ç‚ºä»€éº¼æœƒæœ‰ 401ï¼š

<function_calls>
<invoke name="Read">
<parameter name="path">/Users/danielkai/Desktop/safe-net/apps/mobile/src/screens/elders/ElderListScreen.tsx
