# Safe-Net 最終系統指南

**完成時間**: 2026-01-16  
**狀態**: ✅ 所有功能完整且邏輯清晰

---

## 🎯 系統架構總覽

### 兩個用戶系統（完全獨立）

| 特性 | 後台管理員（users） | App 用戶（app_users） |
|------|-------------------|---------------------|
| **資料表** | users | app_users |
| **註冊方式** | 後台「人員管理」新增 | Mobile App 自行註冊 |
| **查看位置** | 後台 → 人員管理 | 後台 → **App 用戶** ⭐ |
| **登入入口** | 後台 Web | Mobile App |
| **認證 Token** | JWT_SECRET | JWT_APP_SECRET |
| **角色系統** | SUPER_ADMIN/TENANT_ADMIN/STAFF | tenant_members.role |
| **權限範圍** | 管理後台系統 | 查看社區資料、處理警報 |

---

## 📊 後台管理功能完整列表

### 🏠 系統管理（3 個模組）

#### 1. 儀表板
- 系統統計總覽
- 各項數據匯總

#### 2. 人員管理（後台管理員）
- 管理 `users` 表
- 新增/編輯/刪除後台管理員
- 角色：SUPER_ADMIN, TENANT_ADMIN, STAFF
- 這些人**登入後台**管理系統

#### 3. App 用戶管理 ⭐ **新增**
- 管理 `app_users` 表
- 查看所有在 **Mobile App 註冊的用戶**
- 查看用戶已加入的社區
- 編輯/停用/刪除用戶
- 這些人**登入 Mobile App** 使用系統

---

### 🏢 社區管理（1 個核心模組 + 2 個子功能）

#### 主功能：社區 CRUD
- 新增/編輯/刪除社區
- 查看社區統計

#### 子功能 1: 👥 App 成員管理
**點擊社區列表的「👥」圖標**

功能：
- 查看該社區的所有 App 成員
- 批准/拒絕加入申請
- **設為管理員（可多位）**⭐
- 取消管理員
- 顯示批准來源（前台/後台）

#### 子功能 2: 📱 設備管理
**點擊社區列表的「📱」圖標**

功能：
- **分配新設備**（從未分配設備中多選）
- **查看已分配設備**
- 移除未綁定的設備

---

### 📋 業務資料管理（4 個模組）

#### 4. 長者管理
- 長者 CRUD
- 設備綁定（只能選擇社區的設備）
- 狀態管理

#### 5. 設備管理
- 設備 CRUD
- **可不分配社區**（入庫狀態）
- 社區分配狀態追蹤

#### 6. 接收點管理
- 接收點 CRUD
- 類型管理（一般、邊界、移動）

#### 7. 警報管理
- 警報查詢
- 處理/忽略警報
- 統計分析

---

## 🔄 關鍵業務流程

### 流程 1: App 用戶從註冊到使用

```
1. Mobile App 註冊
   用戶在 App 填寫註冊表單
   ↓
   創建 app_users 記錄
   ↓
   【後台可在「App 用戶」查看】⭐

2. 登入 App
   用戶登入 Mobile App
   ↓
   查詢資料（長輩、警報）
   ↓
   因為沒加入社區 → 返回空陣列 []

3. 申請加入社區
   App → 個人 → 加入社區 → 選擇社區
   ↓
   創建 tenant_members（status = PENDING）
   ↓
   【後台可在「社區管理 → 👥」查看】

4. 批准申請
   後台：社區管理 → 社區 → 👥 → 批准
   或
   App：管理員 → 等待確認清單 → 批准
   ↓
   tenant_members.status = APPROVED
   ↓
   【後台「App 用戶」會顯示已加入的社區】⭐

5. 設為管理員
   後台：社區管理 → 社區 → 👥 → 設為管理員
   ↓
   tenant_members.role = ADMIN
   ↓
   用戶在 App 獲得管理員權限
   ↓
   【後台「App 用戶」會顯示「管理員」標籤】⭐

6. 使用系統
   用戶查看長輩、處理警報
   ↓
   可以查詢該社區的資料
```

---

### 流程 2: 設備三階段管理

```
階段 1: 採購入庫
   後台 → 設備管理 → 新增設備
   ↓
   Device { tenantId: null, elderId: null }
   狀態：未分配社區

階段 2: 分配給社區
   後台 → 社區管理 → 社區 → 📱 → 分配新設備
   ↓
   選擇未分配的設備（可多選）
   ↓
   Device { tenantId: 社區ID, elderId: null }
   狀態：已分配社區、未綁定長輩

階段 3: 綁定給長輩
   後台 → 長者管理 → 新增長輩
   ↓
   選擇社區 → 設備選項自動過濾該社區設備
   ↓
   Device { tenantId: 社區ID, elderId: 長輩ID }
   狀態：已綁定長輩
```

---

## 🎨 後台 UI 使用指南

### 查看 App 用戶的兩種方式

#### 方式 1: 總覽所有 App 用戶 ⭐
```
後台 → App 用戶

顯示：
├─ 所有在 Mobile App 註冊的用戶
├─ 用戶狀態（啟用/停用）
├─ 已加入的社區列表
├─ 社區內的角色（管理員/成員）
└─ 最後登入時間

操作：
├─ 編輯用戶資料
├─ 啟用/停用
└─ 刪除用戶（會同時刪除社區成員關係）
```

#### 方式 2: 社區視角的成員管理
```
後台 → 社區管理 → 點擊社區 → 👥

顯示：
├─ 該社區的所有 App 成員
├─ 申請狀態（待批准/已批准/已拒絕）
├─ 成員角色（管理員/一般成員）
└─ 批准來源（前台/後台）

操作：
├─ 批准/拒絕申請
├─ 設為管理員（可設定多位）
└─ 取消管理員
```

---

## 💡 使用場景示例

### 場景：完整的用戶管理流程

1. **用戶註冊** (Mobile App)
   ```
   用戶打開 App → 註冊
   Email: newuser@example.com
   Name: 新用戶
   ```

2. **後台查看** (後台 → App 用戶)
   ```
   可以看到 newuser@example.com
   狀態：啟用
   已加入社區：（空）
   ```

3. **申請加入** (Mobile App)
   ```
   個人 → 加入社區 → 大愛社區
   ```

4. **後台批准** (後台 → 社區管理)
   ```
   社區管理 → 大愛社區 → 👥
   看到 newuser 申請
   點擊「✅ 批准」
   ```

5. **設為管理員** (後台 → 社區管理)
   ```
   在同一 Modal 中
   newuser 變為「已批准」
   點擊「設為管理員」按鈕
   ```

6. **驗證結果** (後台 → App 用戶)
   ```
   回到「App 用戶」頁面
   newuser@example.com 的資訊：
   已加入社區：[🏢 大愛社區 👑 管理員]
   ```

7. **App 使用** (Mobile App)
   ```
   newuser 重新登入
   可以查看大愛社區的長輩
   可以處理警報
   個人頁面顯示管理員功能
   ```

---

## 🎊 架構優勢

### 清晰分離
✅ 後台管理員（users）和 App 用戶（app_users）完全分離  
✅ 不同的認證系統  
✅ 不同的權限體系  

### 靈活管理
✅ 統一查看所有 App 用戶（App 用戶頁面）  
✅ 分社區管理成員（社區管理 → 👥）  
✅ 多位管理員支援  

### 完整流程
✅ 設備三階段管理（入庫 → 分配 → 綁定）  
✅ 成員雙向批准（前台 + 後台）  
✅ 資料隔離保護  

---

## 📚 文檔索引

1. `✅_ARCHITECTURE_FIXED.md` - 本文件（最終架構）
2. `ARCHITECTURE_REVIEW_AND_FIXES.md` - 問題分析
3. `SYSTEM_ARCHITECTURE_CLARIFICATION.md` - 架構說明
4. `ADMIN_FEATURES_COMPLETED.md` - 後台功能補充
5. `USER_MANAGEMENT_ADDED.md` - 人員管理
6. `🎊_ALL_FEATURES_NOW_COMPLETE.md` - 功能總覽

---

**系統現已 100% 完成且邏輯清晰！** 🎉

請重啟後端測試所有功能！
