# 📱 推送通知標準開發流程

## 🎯 正常的開發做法

在 React Native/Expo 開發中，推送通知的**標準流程**是：

---

## 📋 標準流程

### 階段 1：開發階段（使用 Expo Push Service）

#### 1. 使用 Expo 的推送通知服務（推薦）✅

**優點**：
- ✅ 無需配置 Firebase/APNs
- ✅ Expo 自動處理
- ✅ 開發測試快速
- ✅ 支援 Android 和 iOS

**實現方式**：

```typescript
// 前端 - 獲取 Expo Push Token
const token = await Notifications.getExpoPushTokenAsync();
// 結果：ExponentPushToken[xxxxxx]

// 後端 - 使用 expo-server-sdk 發送
import { Expo } from 'expo-server-sdk';

const expo = new Expo();
await expo.sendPushNotificationsAsync([{
  to: token,
  sound: 'default',
  title: '標題',
  body: '內容',
}]);
```

**這就是您目前的實現方式** ✅

---

### 階段 2：發布階段（配置 Firebase/APNs）

當要發布到商店時，才需要：

#### Android - 配置 Firebase

1. 創建 Firebase 專案
2. 下載 `google-services.json`
3. 放到 `android/app/` 目錄
4. 重新編譯

#### iOS - 配置 APNs

1. Apple Developer 帳號
2. 創建 Push Notification 憑證
3. 上傳到 Expo/Firebase

---

## 🔍 您的問題分析

### 為什麼出現 Firebase 錯誤？

因為您使用了 `npx expo run:android`（編譯原生代碼），而不是開發模式。

### 兩種執行模式

#### 模式 A：開發模式（Expo Go）
```bash
npx expo start
# 然後在 Expo Go App 中打開
```
- ✅ 使用 Expo 的推送服務
- ✅ 無需 Firebase
- ✅ 推送通知正常運作

#### 模式 B：原生模式（已編譯）
```bash
npx expo run:android
```
- ⚠️ 需要 Firebase 配置
- ⚠️ 需要 google-services.json
- 這就是您目前遇到的狀況

---

## ✅ 正確的開發流程

### 開發階段（現在）

**使用 Expo Go 或 Expo 開發模式**：

```bash
cd apps/mobile

# 方法 1：使用 Expo Go（推薦）
npx expo start
# 用手機上的 Expo Go App 掃描 QR Code

# 方法 2：使用開發客戶端（需要重新編譯一次）
npx expo install expo-dev-client
npx expo prebuild
npx expo run:android  # 編譯一次後就可以用開發模式
```

### 測試推送通知

在 Expo 開發模式下：
```
1. 登入 App
2. Push Token 自動註冊 ✅
3. 分配警報
4. 收到推送通知 ✅
5. 離開 App 也能收到 ✅
```

---

## 🎯 您現在應該做的

### 選項 A：使用 Expo Go（最快）⭐

```bash
# 1. 停止當前的 App
# 按 Ctrl+C 停止

# 2. 啟動開發模式
cd apps/mobile
npx expo start

# 3. 在手機上：
# - 安裝 Expo Go App
# - 掃描 QR Code
# - 登入測試
```

**優點**：
- 3 分鐘內開始測試
- 推送通知完全正常
- 無需任何配置

---

### 選項 B：配置 Firebase（完整）

如果您需要使用 `npx expo run:android` 運行，則需要配置 Firebase：

```bash
# 1. 創建 Firebase 專案
https://console.firebase.google.com/

# 2. 添加 Android App
# 套件名稱: com.safenet.app

# 3. 下載 google-services.json
# 放到: apps/mobile/android/app/

# 4. 重新編譯
cd apps/mobile
npx expo run:android
```

---

## 📊 模式對比

| 特性 | Expo Go | 原生編譯 + Firebase |
|------|---------|---------------------|
| 推送通知 | ✅ 自動支援 | ✅ 需配置 Firebase |
| 開發速度 | ⚡ 超快 | 🐢 需編譯 |
| 配置需求 | ✅ 零配置 | ⚠️ 需 Firebase |
| 離線通知 | ✅ 支援 | ✅ 支援 |
| 商店發布 | ❌ 不行 | ✅ 可以 |
| 適合階段 | 開發測試 | 發布生產 |

---

## 💡 業界標準做法

### 開發團隊通常這樣做：

1. **開發階段（80% 時間）**
   - 使用 Expo Go 或開發模式
   - 快速迭代和測試
   - 無需擔心配置

2. **準備發布前（15% 時間）**
   - 配置 Firebase（Android）
   - 配置 APNs（iOS）
   - 使用 EAS Build 編譯

3. **發布階段（5% 時間）**
   - 上傳到商店
   - 生產環境測試

---

## 🚀 立即解決方案

### 最簡單的方式（推薦）

```bash
cd apps/mobile

# 停止當前運行（Ctrl+C）

# 啟動 Expo 開發模式
npx expo start

# 選項：
# - 按 'a' 在 Android 模擬器運行（如果有）
# - 或使用實體設備 + Expo Go App 掃描 QR Code
```

**這樣就能收到推送通知了！** ✅

---

## 🔍 為什麼守護者通知能用？

守護者模式使用的是**本地通知**：
```typescript
// 本地通知 - App 內部觸發
await Notifications.scheduleNotificationAsync({
  content: { title, body },
  trigger: null,
});
```

警報系統需要的是**推送通知**：
```typescript
// 推送通知 - 後端發送
// 需要 Push Token 和推送服務
```

**本地通知不需要任何配置**，所以守護者能用。  
**推送通知需要推送服務**（Expo 或 Firebase），所以需要配置。

---

## 📖 Expo 官方建議

根據 Expo 官方文檔：

### 開發測試時
- ✅ 使用 `expo start`（開發模式）
- ✅ 使用 Expo Go 或開發客戶端
- ✅ Expo Push Service 自動可用

### 發布生產時
- 配置 FCM（Android）
- 配置 APNs（iOS）
- 使用 EAS Build

---

## 🎊 總結

**正常的開發做法是**：

✅ **開發時**：使用 Expo 開發模式，自動支援推送通知  
✅ **測試時**：使用 Expo Go 或開發客戶端  
✅ **發布前**：才配置 Firebase/APNs  

**您目前的狀況**：
- 使用了 `expo run:android`（原生編譯模式）
- 需要 Firebase 配置
- 或改用 `expo start`（開發模式）

---

## 🚀 建議行動

**立即（推薦）**：
```bash
cd apps/mobile
npx expo start
# 使用 Expo Go 或按 'a' 在模擬器運行
```

**週末（如果要發布）**：
- 配置 Firebase
- 設置 EAS Build

---

**現在改用 `expo start` 就能收到推送通知了！** 🎉

要我幫您切換到開發模式嗎？
