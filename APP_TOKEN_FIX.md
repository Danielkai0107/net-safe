# App Token é©—è­‰å•é¡Œä¿®å¾©

**ä¿®å¾©æ™‚é–“**: 2026-01-16  
**å•é¡Œ**: App ç™»å…¥å¾Œæ‰€æœ‰ API è«‹æ±‚è¿”å› 401 Unauthorized

---

## ğŸ› å•é¡Œæ ¹æº

### ç—‡ç‹€
- âœ… App å¯ä»¥æˆåŠŸè¨»å†Š/ç™»å…¥
- âŒ ç™»å…¥å¾Œçš„æ‰€æœ‰ API è«‹æ±‚ï¼ˆé•·è¼©æ¸…å–®ã€è­¦å ±æ¸…å–®ã€å€‹äººè³‡æ–™ç­‰ï¼‰éƒ½è¿”å› 401
- âœ… å¾Œå°ç®¡ç†ç³»çµ±æ­£å¸¸é‹ä½œ

### æ ¹æœ¬åŸå› 

åœ¨ `apps/backend/src/app.module.ts` ä¸­è¨­ç½®äº†å…¨å±€çš„ `JwtAuthGuard`ï¼š

```typescript
providers: [
  {
    provide: APP_GUARD,
    useClass: JwtAuthGuard,  // â† é€™æ˜¯å¾Œå°ç®¡ç†å“¡å°ˆç”¨çš„ Guard
  },
]
```

**å•é¡Œæµç¨‹**ï¼š

1. App ç”¨æˆ¶ç™»å…¥ï¼Œå¾Œç«¯ç”¨ `JWT_APP_SECRET` ç”Ÿæˆ token
2. App ç™¼é€è«‹æ±‚åˆ° `/api/app/elders`ï¼Œå¸¶è‘—é€™å€‹ token
3. **å…¨å±€ `JwtAuthGuard` é¦–å…ˆæ””æˆª**ï¼ˆä½¿ç”¨ 'jwt' strategyï¼Œsecret æ˜¯ `JWT_SECRET`ï¼‰
4. å˜—è©¦ç”¨ `JWT_SECRET` é©—è­‰ token â†’ **å¤±æ•—ï¼**ï¼ˆå› ç‚º token æ˜¯ç”¨ `JWT_APP_SECRET` ç°½åçš„ï¼‰
5. è¿”å› 401ï¼Œè«‹æ±‚é€£ Controller éƒ½åˆ°ä¸äº†

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                     å•é¡Œæµç¨‹åœ–                           â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                         â”‚
â”‚  App Token (JWT_APP_SECRET)                            â”‚
â”‚       â”‚                                                 â”‚
â”‚       â†“                                                 â”‚
â”‚  GET /api/app/elders                                   â”‚
â”‚       â”‚                                                 â”‚
â”‚       â†“                                                 â”‚
â”‚  å…¨å±€ JwtAuthGuard (ä½¿ç”¨ JWT_SECRET) â†â”€ âŒ éŒ¯èª¤ï¼      â”‚
â”‚       â”‚                                                 â”‚
â”‚       â†“                                                 â”‚
â”‚  401 Unauthorized                                      â”‚
â”‚                                                         â”‚
â”‚  Controller æ°¸é ä¸æœƒåŸ·è¡Œ âœ—                             â”‚
â”‚                                                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## âœ… ä¿®å¾©æ–¹æ¡ˆ

### ä¿®æ”¹ 1: `apps/backend/src/auth/guards/jwt-auth.guard.ts`

è®“å…¨å±€çš„ `JwtAuthGuard` è·³é App è·¯ç”±ï¼š

```typescript
canActivate(context: ExecutionContext) {
  const isPublic = this.reflector.getAllAndOverride<boolean>(IS_PUBLIC_KEY, [
    context.getHandler(),
    context.getClass(),
  ]);

  if (isPublic) {
    return true;
  }

  // è·³é App ç›¸é—œè·¯ç”±ï¼ˆ/api/app/*ï¼‰ï¼Œè®“ JwtAppAuthGuard è™•ç†
  const request = context.switchToHttp().getRequest();
  if (request.url?.startsWith('/api/app/')) {
    console.log('[JwtAuthGuard] Skipping App route:', request.url);
    return true;
  }

  return super.canActivate(context);
}
```

### ä¿®æ”¹ 2: `apps/backend/src/auth/guards/roles.guard.ts`

è®“å…¨å±€çš„ `RolesGuard` ä¹Ÿè·³é App è·¯ç”±ï¼š

```typescript
canActivate(context: ExecutionContext): boolean {
  // è·³é App ç›¸é—œè·¯ç”±ï¼ˆ/api/app/*ï¼‰ï¼ŒApp æœ‰è‡ªå·±çš„æ¬Šé™ç®¡ç†
  const request = context.switchToHttp().getRequest();
  if (request.url?.startsWith('/api/app/')) {
    return true;
  }

  // ... åŸæœ‰é‚è¼¯
}
```

---

## ğŸ¯ ä¿®å¾©å¾Œçš„æµç¨‹

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                   æ­£ç¢ºçš„æµç¨‹                             â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                         â”‚
â”‚  App Token (JWT_APP_SECRET)                            â”‚
â”‚       â”‚                                                 â”‚
â”‚       â†“                                                 â”‚
â”‚  GET /api/app/elders                                   â”‚
â”‚       â”‚                                                 â”‚
â”‚       â†“                                                 â”‚
â”‚  å…¨å±€ JwtAuthGuard                                     â”‚
â”‚       â”‚                                                 â”‚
â”‚       â”œâ”€ æª¢æŸ¥ï¼šurl.startsWith('/api/app/') ? âœ“        â”‚
â”‚       â”‚                                                 â”‚
â”‚       â””â”€ è·³éï¼Œè¿”å› true                                â”‚
â”‚       â”‚                                                 â”‚
â”‚       â†“                                                 â”‚
â”‚  Controller: @UseGuards(JwtAppAuthGuard)              â”‚
â”‚       â”‚                                                 â”‚
â”‚       â”œâ”€ ä½¿ç”¨ 'jwt-app' strategy                       â”‚
â”‚       â”‚                                                 â”‚
â”‚       â”œâ”€ ç”¨ JWT_APP_SECRET é©—è­‰ token âœ“                â”‚
â”‚       â”‚                                                 â”‚
â”‚       â””â”€ é©—è­‰æˆåŠŸ                                       â”‚
â”‚       â”‚                                                 â”‚
â”‚       â†“                                                 â”‚
â”‚  Service: æª¢æŸ¥ç”¨æˆ¶æ¬Šé™                                 â”‚
â”‚       â”‚                                                 â”‚
â”‚       â””â”€ è¿”å›é•·è¼©æ¸…å–®ï¼ˆæˆ–ç©ºé™£åˆ—ï¼‰âœ“                     â”‚
â”‚                                                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ§ª æ¸¬è©¦æ­¥é©Ÿ

### 1. é‡å•Ÿå¾Œç«¯æœå‹™

```bash
cd /Users/danielkai/Desktop/safe-net
# Ctrl+C åœæ­¢ç•¶å‰æœå‹™
pnpm dev
```

### 2. æ¸¬è©¦ App ç™»å…¥å’Œ API

**æ–¹å¼ Aï¼šä½¿ç”¨ curl**

```bash
# 1. ç™»å…¥
TOKEN=$(curl -X POST http://localhost:3001/api/app/auth/login \
  -H "Content-Type: application/json" \
  -d '{"email":"user1@app.com","password":"password123"}' \
  -s | jq -r '.data.access_token')

echo "Token: $TOKEN"

# 2. æ¸¬è©¦é•·è¼©æ¸…å–® API
curl http://localhost:3001/api/app/elders \
  -H "Authorization: Bearer $TOKEN" \
  -s | jq

# 3. æ¸¬è©¦è­¦å ±æ¸…å–® API
curl http://localhost:3001/api/app/alerts \
  -H "Authorization: Bearer $TOKEN" \
  -s | jq

# 4. æ¸¬è©¦å€‹äººè³‡æ–™ API
curl http://localhost:3001/api/app/auth/me \
  -H "Authorization: Bearer $TOKEN" \
  -s | jq
```

**æ–¹å¼ Bï¼šä½¿ç”¨ Mobile App**

1. æ¸…é™¤ App æ•¸æ“šä¸¦é‡æ–°ç™»å…¥
2. æŸ¥çœ‹è¿½è¹¤æ¸…å–®é é¢ - æ‡‰è©²é¡¯ç¤ºç©ºç™½æˆ–é•·è¼©æ¸…å–®
3. æŸ¥çœ‹è­¦å ±æ¸…å–®é é¢ - æ‡‰è©²é¡¯ç¤ºç©ºç™½æˆ–è­¦å ±æ¸…å–®
4. æŸ¥çœ‹å€‹äººé é¢ - æ‡‰è©²é¡¯ç¤ºç”¨æˆ¶è³‡æ–™

### 3. æª¢æŸ¥å¾Œç«¯æ—¥èªŒ

æ‡‰è©²çœ‹åˆ°é¡ä¼¼çš„æ—¥èªŒï¼š

```
[JwtAuthGuard] Skipping App route: /api/app/elders
[JwtAppStrategy] Validating payload: { sub: '...', email: 'user1@app.com' }
[JwtAppStrategy] User found: { found: true, isActive: true, membershipsCount: 0 }
```

---

## ğŸ“Š é æœŸçµæœ

### ç”¨æˆ¶æœªåŠ å…¥ä»»ä½•ç¤¾å€

- âœ… API è¿”å› 200 OK
- âœ… è¿”å›ç©ºé™£åˆ—ï¼š`{ data: [], meta: { total: 0, ... } }`
- âœ… ä¸å†è¿”å› 401

### ç”¨æˆ¶å·²åŠ å…¥ç¤¾å€

- âœ… API è¿”å› 200 OK
- âœ… è¿”å›ç¤¾å€çš„é•·è¼©/è­¦å ±æ¸…å–®
- âœ… å€‹äººé é¢é¡¯ç¤ºå·²åŠ å…¥çš„ç¤¾å€

---

## ğŸ”„ ç³»çµ±æ¶æ§‹

ä¿®å¾©å¾Œçš„èªè­‰æ¶æ§‹ï¼š

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    èªè­‰æ¶æ§‹                               â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                          â”‚
â”‚  è·¯ç”±                     Guard            Secret        â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€   â”‚
â”‚                                                          â”‚
â”‚  /api/auth/*            â† å…¬é–‹è·¯ç”±ï¼ˆ@Publicï¼‰           â”‚
â”‚                                                          â”‚
â”‚  /api/tenants/*         â† JwtAuthGuard    JWT_SECRET    â”‚
â”‚  /api/users/*             (å¾Œå°ç®¡ç†å“¡)                   â”‚
â”‚  /api/elders/*                                           â”‚
â”‚  /api/devices/*                                          â”‚
â”‚  /api/gateways/*                                         â”‚
â”‚  /api/alerts/*                                           â”‚
â”‚                                                          â”‚
â”‚  /api/app/auth/*        â† å…¬é–‹è·¯ç”±ï¼ˆ@Publicï¼‰           â”‚
â”‚                                                          â”‚
â”‚  /api/app/tenants/*     â† JwtAppAuthGuard JWT_APP_SECRETâ”‚
â”‚  /api/app/elders/*        (App ç”¨æˆ¶)                     â”‚
â”‚  /api/app/alerts/*                                       â”‚
â”‚  /api/app/push/*                                         â”‚
â”‚                                                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ’¡ ç‚ºä»€éº¼å¾Œå°æ²’æœ‰å•é¡Œï¼Ÿ

å¾Œå°å‰ç«¯å’Œ App ä½¿ç”¨**å®Œå…¨ç¨ç«‹**çš„èªè­‰ç³»çµ±ï¼š

| é …ç›® | å¾Œå°ç®¡ç†ç³»çµ± | Mobile App |
|------|------------|------------|
| ç”¨æˆ¶è¡¨ | `users` | `app_users` |
| JWT Secret | `JWT_SECRET` | `JWT_APP_SECRET` |
| Strategy | `JwtStrategy` ('jwt') | `JwtAppStrategy` ('jwt-app') |
| Guard | `JwtAuthGuard` | `JwtAppAuthGuard` |
| API è·¯å¾‘ | `/api/*` | `/api/app/*` |

å¾Œå°çš„ token ç”¨ `JWT_SECRET` ç°½åï¼Œå…¨å±€ `JwtAuthGuard` ä¹Ÿç”¨ `JWT_SECRET` é©—è­‰ï¼Œæ‰€ä»¥æ²’å•é¡Œã€‚

---

## ğŸ”’ å®‰å…¨æ€§èªªæ˜

é€™å€‹ä¿®å¾©æ–¹æ¡ˆæ˜¯å®‰å…¨çš„ï¼š

1. âœ… App è·¯ç”±ä»ç„¶å—åˆ° `JwtAppAuthGuard` ä¿è­·
2. âœ… åªæ˜¯è®“å…¨å±€ Guard è·³éï¼Œä¸æœƒå½±éŸ¿å®‰å…¨æ€§
3. âœ… æ¯å€‹ App Controller éƒ½æ˜ç¢ºä½¿ç”¨ `@UseGuards(JwtAppAuthGuard)`
4. âœ… å¾Œå°è·¯ç”±ç¹¼çºŒå—åˆ°å…¨å±€ Guard ä¿è­·

---

## ğŸ“ ç›¸é—œæ–‡ä»¶

- `MOBILE_APP_API_REFERENCE.md` - App API åƒè€ƒæ–‡æª”
- `SYSTEM_ARCHITECTURE_CLARIFICATION.md` - ç³»çµ±æ¶æ§‹èªªæ˜
- `DATABASE_SETUP_COMPLETE.md` - è³‡æ–™åº«æ–‡æª”

---

**ä¿®å¾©å®Œæˆï¼** ğŸ‰
