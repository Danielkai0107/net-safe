# 🧪 測試警報快速指南

## ⚡ 快速創建測試警報

### 一鍵創建

```bash
pnpm test:alert
```

這會自動：

- ✅ 查找測試數據（社區、長輩、Gateway、成員）
- ✅ 創建邊界警報
- ✅ 自動分配給社區的所有成員（最多 3 人）
- ✅ 設置狀態為 PENDING（等待回覆）
- ✅ 顯示詳細資訊

---

## 🎯 創建不同類型的警報

```bash
pnpm test:alert 1  # 邊界警報（預設）
pnpm test:alert 2  # 不活躍警報
pnpm test:alert 3  # 低電量警報
pnpm test:alert 4  # 緊急警報
```

### 警報類型說明

| 類型       | 代碼        | 嚴重性   | 說明               |
| ---------- | ----------- | -------- | ------------------ |
| 邊界警報   | BOUNDARY    | HIGH     | 長輩在邊界點被偵測 |
| 不活躍警報 | INACTIVE    | CRITICAL | 超過 24 小時未活動 |
| 低電量警報 | LOW_BATTERY | MEDIUM   | 設備電量低於 20%   |
| 緊急警報   | EMERGENCY   | CRITICAL | 緊急求助按鈕觸發   |

---

## 📱 在 App 中測試

### 步驟 1：查看警報

1. 打開 Mobile App
2. 進入「緊急通知」頁面
3. **下拉刷新**列表
4. 應該看到新的測試警報（標題前有 🧪 emoji）

### 步驟 2：測試接受功能

1. 以被分配的成員登入
2. 點擊警報進入詳情
3. 看到「接受警報」和「婉拒」按鈕
4. 點擊「接受警報」
5. 確認接受成功

### 步驟 3：驗證撤銷

1. 以另一個被分配的成員登入
2. 進入「我的警報」
3. 點擊同一個警報
4. 應該看到「此警報已由其他成員處理」

### 步驟 4：管理員查看

1. 以管理員身份登入
2. 進入「緊急通知」→「所有警報」
3. 點擊測試警報
4. 查看「分配狀態」卡片
5. 應該看到：
   - 接受的成員：已接受 🟢
   - 其他成員：已撤銷 ⚫

---

## 🔄 重複測試

### 創建多個警報

```bash
# 快速創建 3 個不同類型的警報
pnpm test:alert 1
pnpm test:alert 2
pnpm test:alert 4
```

### 測試不同場景

1. **場景 A**：第一個人接受

   ```bash
   pnpm test:alert 1
   # 以第一個成員登入並接受
   ```

2. **場景 B**：第一個人婉拒，第二個人接受

   ```bash
   pnpm test:alert 2
   # 以第一個成員登入並婉拒
   # 以第二個成員登入並接受
   ```

3. **場景 C**：管理員重新分配
   ```bash
   pnpm test:alert 3
   # 以管理員登入
   # 進入詳情點擊「重新分配」
   ```

---

## 🗑️ 清理測試數據

### 刪除所有測試警報

```bash
# 使用 Prisma Studio
pnpm db:studio

# 或使用 SQL
# 在 Prisma Studio 中執行：
# DELETE FROM alerts WHERE title LIKE '🧪%';
```

### 重置數據庫（謹慎使用）

```bash
pnpm db:reset
pnpm db:seed
```

⚠️ 這會刪除所有數據並重新建立測試數據

---

## 📊 查看數據

### 使用 Prisma Studio

```bash
pnpm db:studio
```

**查看的表**：

- `alerts` - 所有警報
- `alert_assignments` - 分配記錄
- `push_tokens` - 推送通知 Token（如果有）

**檢查欄位**：

- `alerts.status` - PENDING, NOTIFIED, RESOLVED
- `alert_assignments.status` - PENDING, ACCEPTED, DECLINED, CANCELLED
- `alert_assignments.respondedAt` - 回應時間

---

## 🐛 常見問題

### Q: App 中看不到警報？

**解決方法**：

1. 確認已登入正確的帳號
2. 下拉刷新警報列表
3. 檢查是否在「我的警報」頁面
4. 確認該帳號是社區成員

### Q: 沒有被分配的成員？

**解決方法**：

1. 確認社區有已批准的成員
2. 執行 `pnpm db:seed` 創建測試成員
3. 在後台管理系統中批准成員

### Q: 推送通知沒收到？

**原因**：

- 目前推送通知是模擬模式
- 需要安裝 `expo-server-sdk` 並配置
- 需要在 App 中註冊 Push Token

**查看日誌**：

```bash
cd apps/backend
pnpm dev
# 查看推送通知的日誌輸出
```

---

## 💡 測試技巧

### 快速測試多種場景

```bash
# 終端 1 - 創建警報
pnpm test:alert 1
pnpm test:alert 2
pnpm test:alert 4

# 在 App 中
# - 刷新列表
# - 測試不同的操作
```

### 模擬真實場景

1. **緊急情況**：創建 EMERGENCY 警報，分配給多人
2. **日常巡查**：創建 BOUNDARY 警報，測試接受流程
3. **設備維護**：創建 LOW_BATTERY 警報，測試通知

---

## 📈 測試進度追蹤

### 基本功能

- [ ] 創建測試警報成功
- [ ] App 中可以看到警報
- [ ] 警報資訊正確顯示

### 分配功能

- [ ] 管理員可以看到分配狀態卡片
- [ ] 分配狀態正確顯示（PENDING）
- [ ] 可以打開分配 Modal
- [ ] Modal 顯示成員列表
- [ ] 可以搜尋成員
- [ ] 可以多選成員
- [ ] 分配成功

### 接受功能

- [ ] 成員可以看到「接受」按鈕
- [ ] 點擊接受成功
- [ ] 狀態變為「處理中」
- [ ] 其他人的分配被撤銷
- [ ] 可以更新狀態
- [ ] 可以標記為已完成

### 婉拒功能

- [ ] 成員可以看到「婉拒」按鈕
- [ ] 點擊婉拒顯示確認對話框
- [ ] 婉拒成功
- [ ] 警報從列表中移除
- [ ] 管理員看到「已婉拒」狀態

### 重新分配

- [ ] 管理員可以重新分配
- [ ] 舊分配被清除
- [ ] 新分配生效
- [ ] 狀態重置為 PENDING

---

## 🎊 測試完成檢查

全部測試通過後，您的警報系統應該：

✅ 管理員可以分配警報給多人  
✅ 成員可以接受或婉拒  
✅ 接受後自動撤銷其他人  
✅ 完整的狀態追蹤  
✅ 清晰的視覺回饋

---

## 🚀 下一步

### 啟用真實推送通知

1. 安裝 Expo Push SDK：

   ```bash
   cd apps/backend
   pnpm add expo-server-sdk
   ```

2. 更新 `push-notifications.service.ts`

3. 在 App 中註冊 Push Token

4. 測試真實推送通知

---

**開始測試吧！** 🎉

有任何問題隨時告訴我！
