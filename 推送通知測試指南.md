# 📲 推送通知測試指南

## 🎯 目標

測試**真實的推送通知**，即使 App 關閉也能收到警報通知。

---

## ⚡ 快速測試（5 分鐘）

### 步驟 1：重啟後端

```bash
cd apps/backend
pnpm dev
```

### 步驟 2：重新載入 App

在 Expo 終端按 `r` 重新載入

### 步驟 3：登入 App

- 使用任一測試帳號登入
- 查看日誌確認 Push Token 註冊：
  ```
  [authStore] 註冊推送通知...
  ✅ Push Token 已獲取: ExponentPushToken[...]
  [authStore] ✅ Push Token 已註冊到後端
  ```

### 步驟 4：測試前景通知

1. **保持 App 開啟**
2. 在終端執行：
   ```bash
   pnpm test:alert 4
   ```
3. ✅ 應該在 App 頂部看到通知橫幅

### 步驟 5：測試背景通知

1. **將 App 切換到背景**（按 Home 鍵）
2. 在終端執行：
   ```bash
   pnpm test:alert 2
   ```
3. ✅ 應該在通知中心看到通知
4. 點擊通知應該打開 App

### 步驟 6：測試 App 關閉通知

1. **完全關閉 App**（從最近使用的 App 中滑掉）
2. 在終端執行：
   ```bash
   pnpm test:alert 1
   ```
3. ✅ 應該收到系統通知
4. 點擊通知應該啟動 App

---

## 📊 通知對比

### 本地通知 vs 推送通知

| 特性       | 本地通知    | 推送通知   |
| ---------- | ----------- | ---------- |
| 觸發方式   | App 內部    | 後端伺服器 |
| App 關閉時 | ❌ 不會收到 | ✅ 能收到  |
| 需要網路   | ❌ 不需要   | ✅ 需要    |
| 延遲       | 即時        | 幾秒內     |
| 使用場景   | 守護者模式  | 警報系統   |

---

## 🔍 檢查 Push Token 註冊

### 方法 1：查看資料庫

```bash
pnpm db:studio
```

打開 `push_tokens` 表，確認：

- ✅ 有您的用戶 ID
- ✅ token 欄位有值（ExponentPushToken[...]）
- ✅ isActive 為 true

### 方法 2：查看 App 日誌

在 Expo 終端查看：

```
✅ Push Token 已獲取: ExponentPushToken[xxxxxx]
[authStore] ✅ Push Token 已註冊到後端
```

### 方法 3：查看後端日誌

```
[PushNotificationsController] Register token for user: cmkgfo0tm0000qah8su6odbg9
[PushNotificationsService] Token registered successfully
```

---

## 🧪 完整測試場景

### 場景 1：管理員分配警報

```
1. 以管理員登入（註冊 Push Token）
2. 創建測試警報：pnpm test:alert 4
3. 警報自動分配給所有成員
4. 所有成員收到推送通知 ✅
5. 管理員自己也收到通知
```

### 場景 2：成員接受警報

```
1. 成員 A 收到推送通知
2. 點擊通知打開 App
3. 進入警報詳情
4. 點擊「接受警報」
5. 其他成員收到撤銷通知（未來可實現）
```

### 場景 3：離線接收

```
1. 完全關閉 App
2. 關閉手機螢幕
3. 創建測試警報
4. 手機螢幕亮起顯示通知 ✅
5. 點擊通知啟動 App
```

---

## 🎨 通知樣式

### Android

```
┌─────────────────────────────────┐
│ 🔔 Safe-Net                      │
│                                  │
│ BOUNDARY 警報                    │
│ 陳伯伯 - 陳伯伯 在 社區大門...   │
│                                  │
│ 剛剛                             │
└─────────────────────────────────┘
```

### iOS

```
┌─────────────────────────────────┐
│ Safe-Net         現在            │
│ BOUNDARY 警報                    │
│ 陳伯伯 - 陳伯伯 在 社區大門...   │
└─────────────────────────────────┘
```

---

## 🔧 進階配置

### 自定義通知聲音

在 `app.json` 中添加：

```json
{
  "expo": {
    "notification": {
      "icon": "./assets/notification-icon.png",
      "color": "#2196F3",
      "androidMode": "default",
      "androidCollapsedTitle": "Safe-Net 警報"
    }
  }
}
```

### 添加自定義聲音

1. 將聲音文件放在 `assets/sounds/`
2. 在通知中指定：
   ```typescript
   sound: "alert.wav";
   ```

---

## 📈 監控和調試

### 查看發送統計

後端日誌會顯示：

```
[PushNotificationsService] Sending push notification to 3 devices
[PushNotificationsService] Sent 3 notifications
[PushNotificationsService] Push notification results: 3 success, 0 errors
```

### 查看錯誤

如果有 Token 無效：

```
[PushNotificationsService] Invalid push token: ExponentPushToken[invalid]
[PushNotificationsService] Push notification results: 2 success, 1 errors
```

---

## 💡 最佳實踐

### 1. 確保 Token 有效

- 登入時註冊
- 登出時移除
- 定期更新

### 2. 處理權限

- 首次使用時請求權限
- 權限被拒絕時提示用戶
- 提供設置頁面連結

### 3. 優雅降級

- Push Token 註冊失敗不影響登入
- 推送通知發送失敗不影響警報創建
- 提供 App 內通知作為備選

### 4. 測試覆蓋

- 前景、背景、關閉三種狀態
- Android 和 iOS 都要測試
- 不同的通知類型

---

## 🎊 完成檢查清單

- [ ] 後端已安裝 expo-server-sdk
- [ ] 後端已重啟
- [ ] App 已重新載入
- [ ] 登入時 Push Token 已註冊
- [ ] 資料庫中有 Push Token 記錄
- [ ] 創建測試警報成功
- [ ] 前景狀態收到通知
- [ ] 背景狀態收到通知
- [ ] App 關閉狀態收到通知
- [ ] 點擊通知可以打開 App
- [ ] 後端日誌顯示發送成功

---

**開始測試推送通知吧！** 🚀

記得：

1. 重啟後端
2. 重新載入 App
3. 登入（註冊 Token）
4. 創建測試警報
5. 檢查通知

有任何問題隨時告訴我！
