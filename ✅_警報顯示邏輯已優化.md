# ✅ 警報顯示邏輯已優化

## 🎯 修復的問題

### 問題 1：婉拒後還顯示按鈕
**問題**：婉拒警報後，重新進入詳情頁還會看到「接受」和「婉拒」按鈕

**修復**：
- ✅ 檢查分配狀態（`myAssignmentStatus`）
- ✅ 如果是 DECLINED（已婉拒），不顯示操作按鈕
- ✅ 如果是 CANCELLED（已撤銷），不顯示操作按鈕
- ✅ 只有 PENDING（等待回覆）時才顯示按鈕

### 問題 2：我的警報顯示已婉拒的
**問題**：婉拒後，警報還會出現在「我的警報」列表中

**修復**：
- ✅ 後端查詢改為只返回 PENDING 和 ACCEPTED 狀態的分配
- ✅ DECLINED 和 CANCELLED 的警報不會出現在列表中

### 問題 3：測試警報自動分配
**問題**：測試腳本自動分配給所有成員，無法測試分配功能

**修復**：
- ✅ 測試腳本改為只創建警報，不自動分配
- ✅ 需要管理員手動在 App 中分配
- ✅ 更符合真實使用場景

---

## 📊 新的邏輯

### 警報詳情頁面按鈕顯示邏輯

```typescript
// 檢查我的分配狀態
const myAssignment = alert.assignments?.find(a => a.appUserId === user?.id);
const myAssignmentStatus = myAssignment?.status;

// 只有在以下條件都滿足時才顯示操作按鈕：
if (
  isAssignedToMe &&           // 1. 我被分配了
  !isAcceptedByOther &&       // 2. 沒有被其他人接受
  !isDeclinedByMe &&          // 3. 我沒有婉拒
  !isCancelledForMe &&        // 4. 我的分配沒有被撤銷
  myAssignmentStatus === 'PENDING'  // 5. 狀態是等待回覆
) {
  // 顯示「接受警報」和「婉拒」按鈕
}
```

### 我的警報列表查詢邏輯

```typescript
// 後端查詢
const where = {
  assignments: {
    some: {
      appUserId: userId,
      status: {
        in: ['PENDING', 'ACCEPTED']  // 只顯示這兩種狀態
      }
    }
  }
};

// DECLINED（已婉拒）和 CANCELLED（已撤銷）不會出現
```

---

## 🎨 狀態提示訊息

### 已婉拒
```
┌─────────────────────────────────┐
│ ✗ 您已婉拒此警報                 │  ← 紅色背景
└─────────────────────────────────┘
```

### 已撤銷
```
┌─────────────────────────────────┐
│ ⊘ 您的分配已被撤銷               │  ← 灰色背景
│   （其他成員已接受）             │
└─────────────────────────────────┘
```

### 等待回覆（顯示按鈕）
```
┌─────────────────────────────────┐
│ [接受警報]     [婉拒]            │
└─────────────────────────────────┘
```

---

## 🔄 完整的狀態流轉

### 成員 A 的視角

```
收到警報分配
  ↓
狀態: PENDING
  ↓
在「我的警報」中看到 ✅
  ↓
進入詳情，看到「接受」和「婉拒」按鈕
  ↓
選擇「婉拒」
  ↓
狀態: DECLINED
  ↓
在「我的警報」中消失 ✅
  ↓
重新進入詳情（如果有連結）
  ↓
看到「✗ 您已婉拒此警報」
  ↓
沒有操作按鈕 ✅
```

### 成員 B 的視角

```
收到警報分配
  ↓
狀態: PENDING
  ↓
在「我的警報」中看到 ✅
  ↓
成員 A 接受了警報
  ↓
狀態: CANCELLED（自動）
  ↓
在「我的警報」中消失 ✅
  ↓
重新進入詳情（如果有連結）
  ↓
看到「⊘ 您的分配已被撤銷」
  ↓
沒有操作按鈕 ✅
```

---

## 🧪 測試流程

### 測試 1：婉拒後不顯示按鈕

1. 創建測試警報：
   ```bash
   pnpm test:alert 1
   ```

2. 以管理員登入，分配給成員 A

3. 以成員 A 登入
   - 進入「我的警報」
   - 點擊警報詳情
   - 點擊「婉拒」
   - 確認婉拒

4. 返回警報列表
   - ✅ 該警報應該消失

5. 以管理員登入，進入該警報詳情
   - ✅ 看到成員 A 的狀態為「已婉拒」🔴

6. 以成員 A 重新進入該警報詳情（透過「所有警報」）
   - ✅ 看到「✗ 您已婉拒此警報」訊息
   - ✅ 沒有「接受」和「婉拒」按鈕

---

### 測試 2：撤銷後不顯示按鈕

1. 創建測試警報：
   ```bash
   pnpm test:alert 2
   ```

2. 以管理員登入，分配給成員 A 和成員 B

3. 以成員 A 登入並接受警報

4. 以成員 B 登入
   - 進入「我的警報」
   - ✅ 該警報應該消失（因為被撤銷）

5. 以成員 B 透過「所有警報」進入該警報詳情
   - ✅ 看到「⊘ 您的分配已被撤銷」訊息
   - ✅ 沒有操作按鈕

---

### 測試 3：測試警報不自動分配

1. 創建測試警報：
   ```bash
   pnpm test:alert 4
   ```

2. 以任何成員登入
   - 進入「我的警報」
   - ✅ 應該看不到新警報（因為未分配）

3. 以管理員登入
   - 進入「所有警報」
   - ✅ 看到新警報
   - 進入詳情
   - ✅ 看到「尚未分配」
   - 點擊「分配警報」
   - 選擇成員
   - 確認分配

4. 被分配的成員
   - ✅ 收到推送通知
   - 刷新「我的警報」
   - ✅ 看到新分配的警報

---

## 📋 已更新的文件

```
✅ apps/mobile/src/screens/alerts/AlertDetailScreen.tsx
✅ apps/backend/src/app-alerts/app-alerts.service.ts
✅ scripts/create-test-alert.ts
```

---

## 🎯 改進對比

### 改進前 ❌
- ❌ 婉拒後還能看到操作按鈕
- ❌ 婉拒的警報還在「我的警報」中
- ❌ 撤銷的警報還在「我的警報」中
- ❌ 測試警報自動分配，無法測試分配功能

### 改進後 ✅
- ✅ 婉拒後不顯示操作按鈕
- ✅ 顯示「已婉拒」狀態訊息
- ✅ 婉拒的警報不在「我的警報」中
- ✅ 撤銷的警報不在「我的警報」中
- ✅ 測試警報需要手動分配
- ✅ 更符合真實使用場景

---

## 💡 使用建議

### 創建測試警報後

1. **不要直接以成員身份查看**
   - 因為還沒分配，看不到

2. **先以管理員登入**
   - 進入「所有警報」
   - 找到測試警報
   - 手動分配給成員

3. **然後以成員身份測試**
   - 刷新「我的警報」
   - 測試接受/婉拒功能

---

## 🎊 完成！

現在的警報系統邏輯更加完善：

✅ **狀態判斷準確**
- 婉拒後不顯示按鈕
- 撤銷後不顯示按鈕
- 清晰的狀態提示

✅ **列表過濾正確**
- 「我的警報」只顯示需要處理的
- 已婉拒和已撤銷的不顯示

✅ **測試流程合理**
- 測試警報需要手動分配
- 更符合真實使用場景
- 可以完整測試分配功能

---

**請重啟後端和 App 開始測試！** 🚀
